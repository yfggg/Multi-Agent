

<!DOCTYPE html><html lang="zh"><head>
  <meta name="nav-disable" content="flex">
  
  <link rel="icon" href="https://img.alicdn.com/imgextra/i2/O1CN01TFs5Qw27uYvfA6gib_!!6000000007857-55-tps-32-32.svg" type="image/x-icon">
  <link rel="apple-touch-icon" href="https://img.alicdn.com/imgextra/i2/O1CN01O1Fr0O1P9XCB0psBJ_!!6000000001798-2-tps-96-96.png">
  
  <link rel="dns-prefetch" href="//g.alicdn.com">
  <link rel="dns-prefetch" href="//gw.alicdn.com">
  <link rel="dns-prefetch" href="//gm.mmstat.com">
  <link rel="dns-prefetch" href="//log.mmstat.com">
  <link rel="dns-prefetch" href="//query.aliyun.com">
  <link rel="dns-prefetch" href="//cloud-assets.alicdn.com">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta name="renderer" content="webkit">
  <meta http-equiv="x-ua-compatible" content="ie=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="applicable-device" content="pc,mobile">
  <meta name="nav-config" content="footer=default">
  <meta name="data-spm" content="a2c4g">
  <meta name="aplus-core" content="aplus.js">
  <meta name="aplus-ajax" content="chksum">
  <meta name="aplus-waiting" content="MAN">
  <meta name="aplus-pvhash" content="1">
  <script>
    window.pageStartTime = Date.now();
  </script>


  <title>使用Assistant API构建自动规划的Multi-Agent系统查询阿里云资源-大模型服务平台百炼-阿里云</title>
  <link rel="canonical" href="https://help.aliyun.com/zh/model-studio/use-multi-agent-to-query-alibaba-cloud-resource-information">
  <meta name="keywords" content="Assistant API,构建Multi-Agent系统,学习Assistant API用法,Assistant API代码示例,Multi-Agent系统教程">
  <meta name="description" content="本文教您如何使用Assistant API构建可自动规划任务的Multi-Agent系统，通过提供详细步骤与完整Python代码，助您快速实现阿里云资源查询。">
  <meta name="last-modified" content="2025-12-24T11:29:14+08:00">
  <meta name="date" content="2024-07-15T07:14:22+08:00">
  <meta property="og:title" content="用Assistant API构建Multi-Agent">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://help.aliyun.com/zh/model-studio/use-multi-agent-to-query-alibaba-cloud-resource-information">
  <meta property="og:image" content="https://img.alicdn.com/imgextra/i1/O1CN012QgtoH1c1Mu70xD3w_!!6000000003540-2-tps-640-640.png">
  <meta property="og:description" content="本文教您如何使用Assistant API构建可自动规划任务的Multi-Agent系统，通过提供详细步骤与完整Python代码，助您快速实现阿里云资源查询。">
  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebPage",
      "url": "https://help.aliyun.com/zh/model-studio/use-multi-agent-to-query-alibaba-cloud-resource-information",
      "publisher": {
        "@type": "Organization",
        "name": "阿里云计算",
        "url": "https://www.aliyun.com/",
        "logo": "https://img.alicdn.com/imgextra/i1/O1CN01BEqugB1KebzCRyIJl_!!6000000001189-55-tps-48-48.svg"
      }
    }
  </script>

  <link href="https://g.alicdn.com/aliyun-help/help-portal-fe/0.12.24/css/index.css" rel="stylesheet">
  <script>
    window.globalData = {
      nodeId: "2797088",
    }
    window.$ACE_TRACKER_CONFIG = {
      "enableHistory": true,
      "enableHash": false
    }
  </script>
<script>
    window.__ICE_SSR_ENABLED__=true;
    window.__ICE_APP_DATA__={};
window.__ICE_PAGE_PROPS__={"docDetailData":{"storeData":{"alias":"/model-studio/use-multi-agent-to-query-alibaba-cloud-resource-information","nodeId":null,"data":{"lastModifiedTime":1766546954000,"keywords":"Assistant API,构建Multi-Agent系统,学习Assistant API用法,Assistant API代码示例,Multi-Agent系统教程","docTitle":"借助 Assistant API 构建具备自动规划能力的 Multi Agent 系统","language":"zh","seoTitle":"使用Assistant API构建自动规划的Multi-Agent系统查询阿里云资源-大模型服务平台百炼-阿里云","title":"用Assistant API构建Multi-Agent","content":"<div lang=\"zh\" class=\"icms-help-docs-content\">\n<main id=\"main-2725769\"><p id=\"96d23029aajre\" data-tag=\"shortdesc\" class=\"shortdesc\">本文将通过构建一个查询阿里云资源信息的<span class=\"help-letter-space\"></span>Multi Agent<span class=\"help-letter-space\"></span>系统，帮助您了解如何通过阿里云百炼平台的<span class=\"help-letter-space\"></span>Assistant API<span class=\"help-letter-space\"></span>构建一个无需提前定义、可自动规划编排任务流程的<span class=\"help-letter-space\"></span>Multi Agent<span class=\"help-letter-space\"></span>系统。</p><div data-tag=\"body\" class=\"body\"><p id=\"865e8c1b81ssb\">多智能体系统（Multi Agent System）是多个<span class=\"help-letter-space\"></span>Agent<span class=\"help-letter-space\"></span>协作完成任务的方式，在多数场景下，比单<span class=\"help-letter-space\"></span>Agent<span class=\"help-letter-space\"></span>完成任务准确率更高。通过给每个<span class=\"help-letter-space\"></span>Agent<span class=\"help-letter-space\"></span>制定明确且专业的角色名称和职责描述，不仅可以提升它们的专业性，还能帮助它们更好地理解和配合各自的工作。Multi Agent System<span class=\"help-letter-space\"></span>的设计十分灵活，您可以参考本案例中的设计和示例代码，将其应用到您的业务中。</p><section id=\"17108a6a7cz9d\" class=\"section\"><h2 id=\"e0a5b2295fz8p\"><b>效果展示</b></h2><p id=\"0b32e2662etyg\">通过本文提供的教程，您可以实现一个能进行阿里云资源信息查询的 Multi Agent 系统。该系统在收到用户问题后，会自动规划多个 Agent 之间的协作流程，按照规划执行任务后给出最终答案。</p><table bordertype=\"no-border\" id=\"9821cf98c10s5\" tablewidth=\"100\" tablecolswidth=\"47.54 52.46\" autofit=\"true\" class=\"table\"><colgroup colwidth=\"0.95*\" style=\"width:47.54%\"></colgroup><colgroup colwidth=\"1.05*\" style=\"width:52.46%\"></colgroup><tbody class=\"tbody\"><tr id=\"6dab2954439mb\" style=\"height:33px\"><td id=\"35fba2ff59b6q\" rowspan=\"1\" style=\"vertical-align:top\" colspan=\"1\"><p id=\"80678db71dz7o\"><img id=\"b509cb2154yke\" src=\"https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/9873322271/p826565.png\" alt=\"image\" placement=\"break\" class=\"image break\"></p></td><td id=\"7bd3b4b7c9vdq\" rowspan=\"1\" style=\"vertical-align:top\" colspan=\"1\"><p id=\"644d609bdf2ox\"><img id=\"ca84dee9821xl\" src=\"https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/9873322271/p826567.gif\" alt=\"output\" placement=\"break\" class=\"image break\"></p></td></tr></tbody></table><p id=\"d82d6e4de3c69\"><b>详细工作流程：</b></p><ol id=\"e47d9beef4q5l\"><li id=\"6cdebdf9eajz3\"><p id=\"513d2bdb8clqs\">用户进行提问；</p></li><li id=\"f818e498a6lhe\"><p id=\"8e315853b8u38\">PlannerAssistant<span class=\"help-letter-space\"></span>接收到用户的提问，并根据用户问题对其它<span class=\"help-letter-space\"></span>Agent<span class=\"help-letter-space\"></span>进行选择并编排其运行顺序；</p></li><li id=\"39eb2224894tu\"><p id=\"7caf5f9d0fauu\">ChatAssistant、AliyunInfoAssistant<span class=\"help-letter-space\"></span>与<span class=\"help-letter-space\"></span>InstanceTypeDetailAssistant<span class=\"help-letter-space\"></span>分别有对应的职责与能力，它们是本教程<span class=\"help-letter-space\"></span>Multi Agent<span class=\"help-letter-space\"></span>系统中被<span class=\"help-letter-space\"></span>PlannerAssistant<span class=\"help-letter-space\"></span>编排的<span class=\"help-letter-space\"></span>Agent。编排完成后的<span class=\"help-letter-space\"></span>Agent<span class=\"help-letter-space\"></span>组合会接收用户的提问，并按照程序中设计的<span class=\"help-letter-space\"></span>Multi Agent<span class=\"help-letter-space\"></span>交互逻辑进行分工合作；</p></li><li id=\"2fa5343ca3yke\"><p id=\"c834e9fe50o4l\">SummaryAssistant<span class=\"help-letter-space\"></span>将各<span class=\"help-letter-space\"></span>Agent<span class=\"help-letter-space\"></span>的输出信息汇总，并结合用户问题对信息进行总结，其输出会作为<span class=\"help-letter-space\"></span>Multi Agent<span class=\"help-letter-space\"></span>系统的最终输出。</p></li></ol></section><section id=\"8de022a754rpk\" class=\"section\"><h2 id=\"01971ae2417uk\"><b>前提条件</b></h2><ol id=\"228dd09b0en4z\"><li id=\"7fed9ae1f9603\"><p id=\"dcd8ab5d81n18\">请参考<a href=\"https://help.aliyun.com/zh/ram/user-guide/create-an-accesskey-pair\" id=\"5e2b0caca896i\" title=\"\" class=\"xref\">创建<span class=\"help-letter-space\"></span>AccessKey</a>，获取用户的<code data-tag=\"code\" code-type=\"xCode\" id=\"72c3a28393eu7\" class=\"code\">ACCESS_KEY_ID</code>和<code data-tag=\"code\" code-type=\"xCode\" id=\"af92bd7492j1j\" class=\"code\">ACCESS_KEY_SECRET</code>。</p></li><li id=\"247b9ef8d7m57\"><p id=\"97b1e8426c26g\">请开通阿里云百炼服务并<a href=\"https://help.aliyun.com/zh/model-studio/get-api-key\" id=\"270b3e35605qq\" title=\"\" class=\"xref\">获取与配置 API Key</a>。</p></li><li id=\"378166f9fcpog\"><p id=\"db8adfe8e8jcv\">我们推荐您将<code data-tag=\"code\" code-type=\"xCode\" id=\"061c7e1c75ssz\" class=\"code\">ALIBABA_CLOUD_ACCESS_KEY_ID</code>、<code data-tag=\"code\" code-type=\"xCode\" id=\"8a436ba0c9z3b\" class=\"code\">ALIBABA_CLOUD_ACCESS_KEY_SECRET</code>和<code data-tag=\"code\" code-type=\"xCode\" id=\"b716074fcd21c\" class=\"code\">DASHSCOPE_API_KEY</code>配置在环境变量中，以降低泄露风险。环境变量配置方法可参考：<a href=\"https://help.aliyun.com/zh/model-studio/configure-api-key-through-environment-variables\" id=\"9b3f41e31fenk\" title=\"\" class=\"xref\">配置<span class=\"help-letter-space\"></span>API Key<span class=\"help-letter-space\"></span>到环境变量</a>。在本教程中，您可以参考以下命令，根据您的操作系统选择配置环境变量的方法：</p><div outputclass=\"tabbed-codeblock\" data-tag=\"fig\" id=\"a71542f4f1uie\" class=\"tabbed-codeblock-box\"><div class=\"tab-box\"></div><input type=\"radio\" name=\"check-a71542f4f1uie\" id=\"a71542f4f1uie-bash-tab\" checked=\"\"><label for=\"a71542f4f1uie-bash-tab\">Bash</label><div class=\"codeblock-item\"><pre code-type=\"xCode\" id=\"0964de0b50nlb\" data-tag=\"codeblock\" outputclass=\"language-bash\" class=\"pre codeblock language-bash\"><code># 用您的<span class=\"help-letter-space\"></span>API-KEY<span class=\"help-letter-space\"></span>与阿里云<span class=\"help-letter-space\"></span>AK<span class=\"help-letter-space\"></span>信息进行替换\nexport DASHSCOPE_API_KEY=\"YOUR_DASHSCOPE_API_KEY\"\nexport ALIBABA_CLOUD_ACCESS_KEY_ID=\"YOUR_ALIBABA_CLOUD_ACCESS_KEY_ID\"\nexport ALIBABA_CLOUD_ACCESS_KEY_SECRET=\"YOUR_ALIBABA_CLOUD_ACCESS_KEY_SECRET\"</code></pre></div><input type=\"radio\" name=\"check-a71542f4f1uie\" id=\"a71542f4f1uie-powershell-tab\"><label for=\"a71542f4f1uie-powershell-tab\">PowerShell</label><div class=\"codeblock-item\"><pre code-type=\"xCode\" id=\"a0e22394adu3c\" data-tag=\"codeblock\" outputclass=\"language-powershell\" class=\"pre codeblock language-powershell\"><code># 用您的<span class=\"help-letter-space\"></span>API-KEY<span class=\"help-letter-space\"></span>与阿里云<span class=\"help-letter-space\"></span>AK<span class=\"help-letter-space\"></span>信息进行替换\n$env:DASHSCOPE_API_KEY = \"YOUR_DASHSCOPE_API_KEY\"\n$env:ALIBABA_CLOUD_ACCESS_KEY_ID=\"YOUR_ALIBABA_CLOUD_ACCESS_KEY_ID\"\n$env:ALIBABA_CLOUD_ACCESS_KEY_SECRET=\"YOUR_ALIBABA_CLOUD_ACCESS_KEY_SECRET\"</code></pre></div></div></li><li id=\"47b2012cebju9\"><p id=\"1d5674b8507mv\">如果您没有创建<span class=\"help-letter-space\"></span>ECS<span class=\"help-letter-space\"></span>实例，请前往<span class=\"help-letter-space\"></span><a class=\"\" href=\"https://ecs.console.aliyun.com\" id=\"304b888646kor\">ECS<span class=\"help-letter-space\"></span>控制台</a>创建一个按量付费的实例。</p><div type=\"note\" id=\"fd34fe1f32pq3\" class=\"note note-note\"><div class=\"note-icon-wrapper\"><i class=\"icon-note note note\"></i></div><div class=\"noteContentSpan\"><strong>说明 </strong><p id=\"31a90b507b0cq\">如果您在完成本实践教程后没有继续使用<span class=\"help-letter-space\"></span>ECS<span class=\"help-letter-space\"></span>实例的需求，请及时释放您的<span class=\"help-letter-space\"></span>ECS<span class=\"help-letter-space\"></span>资源，避免产生不必要的消费。</p></div></div></li><li id=\"6a30974fd3b52\"><p id=\"940c6dfcc4y6j\">请确认您的计算环境中已安装<span class=\"help-letter-space\"></span>Python。您可以新建一个<code data-tag=\"code\" code-type=\"xCode\" id=\"5987d69cbahrs\" class=\"code\">requirements.txt</code>文件，将以下内容复制到<span class=\"help-letter-space\"></span>txt<span class=\"help-letter-space\"></span>文件中。</p><pre code-type=\"xCode\" id=\"b78881e94dkkg\" data-tag=\"codeblock\" outputclass=\"language-plaintext\" class=\"pre codeblock language-plaintext\"><code>alibabacloud_tea_openapi\nalibabacloud_tea_util\nalibabacloud_openapi_util\nalibabacloud_ecs20140526\nalibabacloud_bssopenapi20171214\ndashscope\ngradio</code></pre><p id=\"fc9c1bc7c50jo\">在您保存<code data-tag=\"code\" code-type=\"xCode\" id=\"1701bac42bs4g\" class=\"code\">requirements.txt</code>文件后，请您在<code data-tag=\"code\" code-type=\"xCode\" id=\"dce97fe1b5f17\" class=\"code\">requirements.txt</code>所在目录中运行以下命令安装依赖：</p><pre code-type=\"xCode\" id=\"faac93981997g\" data-tag=\"codeblock\" outputclass=\"language-bash\" class=\"pre codeblock language-bash\"><code>pip install -r requirements.txt</code></pre></li><li id=\"d6285015f3whx\"><p id=\"9f841fb8abp6p\">请您参考<span class=\"help-letter-space\"></span><a href=\"https://help.aliyun.com/zh/model-studio/build-knowledge-base-qa-assistant-without-coding/\" id=\"8ed7b5893570t\" title=\"\" class=\"xref\">0<span class=\"help-letter-space\"></span>代码构建问答应用</a>文档，在阿里云百炼平台创建<span class=\"help-letter-space\"></span>RAG<span class=\"help-letter-space\"></span>应用，知识库文件选择<span class=\"help-letter-space\"></span>PDF<span class=\"help-letter-space\"></span>格式的阿里云<span class=\"help-letter-space\"></span>ECS<span class=\"help-letter-space\"></span>官方文档<a class=\"file\" href=\"https://help-static-aliyun-doc.aliyuncs.com/file-manage-files/zh-CN/20240701/dnazer/%E5%AE%9E%E4%BE%8B%E8%A7%84%E6%A0%BC%E6%97%8F.pdf\" id=\"11bff869f0259\">实例规格族.pdf</a>，并获取其应用<span class=\"help-letter-space\"></span>ID。</p><p id=\"eb101a789az8h\"><img id=\"ca72c5eabf23g\" src=\"https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/8977177471/p957657.png\" alt=\"image\" placement=\"break\" props=\"china\" width=\"450\" height=\"193.088\" data-cond-props=\"china\" class=\"image break\"></p><p id=\"10f2a65ef4o8r\"></p></li></ol></section><section id=\"afc21a1265tnb\" class=\"section\"><h2 id=\"fabe2556eavti\"><b>代码实现</b></h2><p id=\"5424955895rp5\">您需要准备两个<span class=\"help-letter-space\"></span>py<span class=\"help-letter-space\"></span>文件，分别为<code data-tag=\"code\" code-type=\"xCode\" id=\"2d8ca42e4579e\" class=\"code\">tools.py</code>与<code data-tag=\"code\" code-type=\"xCode\" id=\"1ddb6419eeooi\" class=\"code\">main.py</code>，这两个文件需要放置在同一目录中。</p><section id=\"01b82195e6ob5\" class=\"section\"><h3 id=\"74d240e4f1llz\"><b>工程文件</b></h3><p id=\"31ccd092c4dih\">请下载<span class=\"help-letter-space\"></span><a class=\"file\" href=\"https://help-static-aliyun-doc.aliyuncs.com/file-manage-files/zh-CN/20250811/zqkfgg/multi_agent.zip\" id=\"954bafecbav0r\">multi_agent.zip</a><span class=\"help-letter-space\"></span>到本地后进行解压。</p></section><section id=\"23d90557e8omq\" class=\"section\"><h3 id=\"00ba95b176dzh\"><b>tools.py（用于定义工具函数）</b></h3><p id=\"5e3e9089277l9\"><code data-tag=\"code\" code-type=\"xCode\" id=\"63acc14c4cp0m\" class=\"code\">tools.py</code>主要定义了<span class=\"help-letter-space\"></span>Agent<span class=\"help-letter-space\"></span>会使用到的工具函数。<code data-tag=\"code\" code-type=\"xCode\" id=\"43a9197c981hu\" class=\"code\">tools.py</code>整体代码可见<span class=\"help-letter-space\"></span><a href=\"#1665f852562ik\" id=\"2433f28f6bn0w\" title=\"\" class=\"xref\">tools.py<span class=\"help-letter-space\"></span>整体代码</a>。</p><h4 id=\"32689d5042z7u\"><b>引入依赖</b></h4><pre code-type=\"xCode\" id=\"5d092b11893dh\" data-tag=\"codeblock\" outputclass=\"language-python\" props=\"china\" data-cond-props=\"china\" class=\"pre codeblock language-python\"><code>from alibabacloud_tea_util import models as util_models\nfrom alibabacloud_ecs20140526.client import Client as Ecs20140526Client\nfrom alibabacloud_ecs20140526 import models as ecs_20140526_models\nfrom alibabacloud_tea_openapi import models as open_api_models\nfrom alibabacloud_bssopenapi20171214.client import Client as BssOpenApi20171214Client\nfrom dashscope import Application\nimport os</code></pre><h4 id=\"bc610d6be88x5\"><b>定义工具</b></h4><p id=\"631ad6373cxom\"><code data-tag=\"code\" code-type=\"xCode\" id=\"6ba2e69eaczki\" class=\"code\">tools.py</code>中主要使用到了两个工具类，分别为<span class=\"help-letter-space\"></span>ECS<span class=\"help-letter-space\"></span>与<span class=\"help-letter-space\"></span>Billing。ECS<span class=\"help-letter-space\"></span>的类方法包含有<code data-tag=\"code\" code-type=\"xCode\" id=\"a52003957579z\" class=\"code\">query_source</code>和<code data-tag=\"code\" code-type=\"xCode\" id=\"19e5f338ff0ot\" class=\"code\">call_agent_app</code>，Billing<span class=\"help-letter-space\"></span>的类方法包含<code data-tag=\"code\" code-type=\"xCode\" id=\"1e5a408a67wsl\" class=\"code\">get_balance</code>。您可以参考以下代码，添加您需要的工具类与工具函数以适配您的业务。</p><section outputclass=\"tabbed-content-box\" id=\"a378da0f7506t\" data-tag=\"tabbed-content-box\" class=\"tabbed-content-box section\"><section id=\"138601279083v\" class=\"section\"><h5 id=\"a5e271f90bjs5\"><b>ECS</b></h5><p id=\"20ba8a6a53zw2\">ECS<span class=\"help-letter-space\"></span>有两个类函数：<code data-tag=\"code\" code-type=\"xCode\" id=\"f75b3f4c3afz0\" class=\"code\">query_source</code>与<code data-tag=\"code\" code-type=\"xCode\" id=\"396724a5efk72\" class=\"code\">call_agent_app</code>。</p><p id=\"8937e05fa735p\"><code data-tag=\"code\" code-type=\"xCode\" id=\"49cffa75a4x9q\" class=\"code\">query_source</code>通过阿里云的<span class=\"help-letter-space\"></span>OpenAPI<span class=\"help-letter-space\"></span>服务查询指定区域的<span class=\"help-letter-space\"></span>ECS<span class=\"help-letter-space\"></span>实例信息。函数输入为<span class=\"help-letter-space\"></span>RegionID，如<code data-tag=\"code\" code-type=\"xCode\" id=\"b37bd32626yz4\" class=\"code\">cn-hangzhou</code>、<code data-tag=\"code\" code-type=\"xCode\" id=\"4c10724fe8hfl\" class=\"code\">cn-beijing</code>、<code data-tag=\"code\" code-type=\"xCode\" id=\"7a21195557rd4\" class=\"code\">cn-shanghai</code>、<code data-tag=\"code\" code-type=\"xCode\" id=\"e0d9aa3794ugb\" class=\"code\">ap-southeast-1</code>等；输出包含实例<span class=\"help-letter-space\"></span>ID、实例规格与价格信息。</p><p id=\"49e77bfde8yj1\"><code data-tag=\"code\" code-type=\"xCode\" id=\"c08076b0799jv\" class=\"code\">call_agent_app</code>函数通过集成阿里云<span class=\"help-letter-space\"></span>ECS<span class=\"help-letter-space\"></span>官方文档<a class=\"file\" href=\"https://help-static-aliyun-doc.aliyuncs.com/file-manage-files/zh-CN/20240701/dnazer/%E5%AE%9E%E4%BE%8B%E8%A7%84%E6%A0%BC%E6%97%8F.pdf\" id=\"763855c4b4cf5\">实例规格族.pdf</a><span class=\"help-letter-space\"></span>知识库的阿里云百炼<span class=\"help-letter-space\"></span>RAG<span class=\"help-letter-space\"></span>应用查询实例规格的详细信息，包括<span class=\"help-letter-space\"></span>vCPU<span class=\"help-letter-space\"></span>个数、内存大小等指标数据。您需要获取您在阿里云百炼创建应用的<code data-tag=\"code\" code-type=\"xCode\" id=\"769b7f912920r\" class=\"code\">app_id</code>并在代码中的对应位置进行替换。函数输入参数为<span class=\"help-letter-space\"></span>ECS<span class=\"help-letter-space\"></span>实例规格列表，如<code data-tag=\"code\" code-type=\"xCode\" id=\"a2c2220e0f0k1\" class=\"code\">['ecs.e-c1m1.large', 'ecs.u1-c1m4.xlarge']</code>，输出为<span class=\"help-letter-space\"></span>RAG<span class=\"help-letter-space\"></span>应用的回复。需要注意的是，与<span class=\"help-letter-space\"></span>Agent<span class=\"help-letter-space\"></span>相似，RAG<span class=\"help-letter-space\"></span>应用的背后也是基于大模型驱动，因此<code data-tag=\"code\" code-type=\"xCode\" id=\"3e00696dee5l0\" class=\"code\">call_agent_app</code>的运行时间可能较长。</p><p id=\"777402b04fbf3\"><b>ECS<span class=\"help-letter-space\"></span>类</b>的定义代码如下：</p><div id=\"ce72da3e77lmp\" type=\"note\" class=\"note note-note\"><div class=\"note-icon-wrapper\"><i class=\"icon-note note note\"></i></div><div class=\"noteContentSpan\"><strong>说明 </strong><p id=\"468a6905bezo7\">请用您在阿里云百炼平台创建的<span class=\"help-letter-space\"></span>RAG<span class=\"help-letter-space\"></span>应用的<code data-tag=\"code\" code-type=\"xCode\" id=\"666ce0c7c2onl\" class=\"code\">app_id</code>替代代码中的<code data-tag=\"code\" code-type=\"xCode\" id=\"c15eb80a353xt\" class=\"code\">app_id</code>。</p></div></div><pre code-type=\"xCode\" id=\"063bdc69a4jgy\" data-tag=\"codeblock\" outputclass=\"language-python\" props=\"china\" data-cond-props=\"china\" class=\"pre codeblock language-python\"><code>class ECS:\n    @classmethod\n    # 输入：地域ID，如cn-hangzhou，cn-beijing等\n    # 输出：查询ecs实例规格信息，包括实例ID，实例规格，每小时收费。（系统盘默认按照cloud_auto，40GiB）\n    def query_source(cls,RegionID):\n        config = open_api_models.Config(\n                # 从环境变量中获取阿里云的AK信息\n                access_key_id=os.getenv(\"ALIBABA_CLOUD_ACCESS_KEY_ID\"),\n                access_key_secret=os.getenv(\"ALIBABA_CLOUD_ACCESS_KEY_SECRET\")\n            )\n        # 杭州与北京、上海等地区的endpoint不同，此处进行判断\n        if RegionID != 'cn-hangzhou':\n            config.endpoint = f'ecs.{RegionID}.aliyuncs.com'\n        else:\n            config.endpoint = f'ecs-{RegionID}.aliyuncs.com'\n        client = Ecs20140526Client(config)\n        describe_instances_request = ecs_20140526_models.DescribeInstancesRequest(region_id=RegionID)\n        runtime = util_models.RuntimeOptions()\n        # 获得ECS实例信息\n        response_source = client.describe_instances_with_options(describe_instances_request, runtime).body\n        if len(response_source.instances.instance) == 0:\n            return \"您在当前区域无ecs实例\"\n        # 初始化要返回的结果\n        result = \"\"\n        # 可能有多个实例，因此用for循环遍历所有实例\n        for i in range(len(response_source.instances.instance)):\n            # 系统盘类型与存储空间，此处默认设为cloud_auto，40GiB\n            system_disk = ecs_20140526_models.DescribePriceRequestSystemDisk(\n                category='cloud_auto',\n                size=40\n            )\n            describe_price_request = ecs_20140526_models.DescribePriceRequest(\n                region_id=RegionID,\n                resource_type='instance',\n                instance_type=response_source.instances.instance[i].instance_type,\n                system_disk=system_disk\n            )\n            response = client.describe_price_with_options(describe_price_request, runtime).body\n            cur_result = f\"\"\"实例：{response_source.instances.instance[i].instance_id} 的规格为：{response_source.instances.instance[i].instance_type}，\n    每个小时的收费为{response.price_info.price.trade_price}元\\n\"\"\"\n            # 将当前实例的信息添加到返回结果中\n            result += cur_result\n        return result\n    @classmethod\n    # RAG应用调用\n    def call_agent_app(cls,InstanceType):\n        if len(InstanceType) == 0:\n            return \"您在当前区域无ecs实例\"\n        result = \"\"\n        for i in range(len(InstanceType)):\n            response = Application.call(\n                # 此处填写RAG应用的app_id\n                app_id='xxx',\n                prompt=f'介绍一下{InstanceType[i]}',\n                # 从环境变量中获取Dashscope的API Key\n                api_key=os.getenv(\"DASHSCOPE_API_KEY\"))\n            result += response.output.text\n        return result</code></pre></section><section id=\"2e2655d556c6h\" class=\"section\"><h5 id=\"9d4b302b0ejxo\"><b>Billing</b></h5><p id=\"00691ecabdl2q\">Billing<span class=\"help-letter-space\"></span>类中有一个函数<code data-tag=\"code\" code-type=\"xCode\" id=\"6c310c6296x3p\" class=\"code\">get_balance</code>。</p><p id=\"39eb608bfbgz6\"><code data-tag=\"code\" code-type=\"xCode\" id=\"9e2d04c0c4w01\" class=\"code\">get_balance</code>通过阿里云的<span class=\"help-letter-space\"></span>OpenAPI<span class=\"help-letter-space\"></span>服务查询阿里云的余额信息。</p><pre id=\"3de4ea431bu42\" outputclass=\"language-python\" data-tag=\"codeblock\" code-type=\"xCode\" class=\"pre codeblock language-python\"><code>class Billing:\n    # 无需输入，返回为阿里云账户余额信息\n    @classmethod\n    def get_balance(cls):\n        # 创建客户端\n        config = open_api_models.Config(\n            # 必填，请确保代码运行环境设置了环境变量 ALIBABA_CLOUD_ACCESS_KEY_ID。,\n            access_key_id=os.environ['ALIBABA_CLOUD_ACCESS_KEY_ID'],\n            # 必填，请确保代码运行环境设置了环境变量 ALIBABA_CLOUD_ACCESS_KEY_SECRET。,\n            access_key_secret=os.environ['ALIBABA_CLOUD_ACCESS_KEY_SECRET']\n        )\n        # Endpoint 请参考 https://api.aliyun.com/product/BssOpenApi\n        config.endpoint = f'business.aliyuncs.com'\n        runtime = util_models.RuntimeOptions()\n        client = BssOpenApi20171214Client(config)\n        balance_info = client.query_account_balance_with_options(runtime).body.data\n        return f\"\"\"币种为：{balance_info.currency}，可用额度为{balance_info.available_amount}，信控余额为{balance_info.credit_amount}，\n        网商余额为{balance_info.mybank_credit_amount}，现金余额为{balance_info.available_cash_amount}，生态客户Quota限额为{balance_info.quota_limit}。\"\"\"</code></pre></section></section><h4 id=\"1665f852562ik\"><code data-tag=\"code\" code-type=\"xCode\" id=\"bb9ab0a95bvsn\" class=\"code\"><b>tools.py</b></code><b>整体代码</b></h4><p id=\"4f19bd4245qdm\"><code data-tag=\"code\" code-type=\"xCode\" id=\"6432f38177070\" class=\"code\">tools.py</code>整体代码如下：</p><pre id=\"8b6df9d9181fw\" outputclass=\"language-python\" data-tag=\"codeblock\" code-type=\"xCode\" props=\"china\" data-cond-props=\"china\" class=\"pre codeblock language-python\"><code>from alibabacloud_tea_util import models as util_models\nfrom alibabacloud_ecs20140526.client import Client as Ecs20140526Client\nfrom alibabacloud_ecs20140526 import models as ecs_20140526_models\nfrom alibabacloud_tea_openapi import models as open_api_models\nfrom alibabacloud_bssopenapi20171214.client import Client as BssOpenApi20171214Client\nfrom dashscope import Application\nimport os\n\nclass ECS:\n    @classmethod\n    # 输入：地域ID，如cn-hangzhou，cn-beijing等\n    # 输出：查询ecs实例规格信息，包括实例ID，实例规格，每小时收费。（系统盘默认按照cloud_auto，40GiB）\n    def query_source(cls,RegionID):\n        config = open_api_models.Config(\n                # 从环境变量中获取阿里云的AK信息\n                access_key_id=os.getenv(\"ALIBABA_CLOUD_ACCESS_KEY_ID\"),\n                access_key_secret=os.getenv(\"ALIBABA_CLOUD_ACCESS_KEY_SECRET\")\n            )\n        # 杭州与北京上海等地区的endpoint不同，此处进行判断\n        if RegionID != 'cn-hangzhou':\n            config.endpoint = f'ecs.{RegionID}.aliyuncs.com'\n        else:\n            config.endpoint = f'ecs-{RegionID}.aliyuncs.com'\n        client = Ecs20140526Client(config)\n        describe_instances_request = ecs_20140526_models.DescribeInstancesRequest(region_id=RegionID)\n        runtime = util_models.RuntimeOptions()\n        # 获得ECS实例信息\n        response_source = client.describe_instances_with_options(describe_instances_request, runtime).body\n        if len(response_source.instances.instance) == 0:\n            return \"您在当前区域无ecs实例\"\n        # 初始化要返回的结果\n        result = \"\"\n        # 可能有多个实例，因此用for循环遍历所有实例\n        for i in range(len(response_source.instances.instance)):\n            # 系统盘类型与存储空间，此处默认设为cloud_auto，40GiB\n            system_disk = ecs_20140526_models.DescribePriceRequestSystemDisk(\n                category='cloud_auto',\n                size=40\n            )\n            describe_price_request = ecs_20140526_models.DescribePriceRequest(\n                region_id=RegionID,\n                resource_type='instance',\n                instance_type=response_source.instances.instance[i].instance_type,\n                system_disk=system_disk\n            )\n            response = client.describe_price_with_options(describe_price_request, runtime).body\n            cur_result = f\"\"\"实例：{response_source.instances.instance[i].instance_id} 的规格为：{response_source.instances.instance[i].instance_type}，\n    每个小时的收费为{response.price_info.price.trade_price}元\\n\"\"\"\n            # 将当前实例的信息添加到返回结果中\n            result += cur_result\n        return result\n    @classmethod\n    # RAG应用调用\n    def call_agent_app(cls,InstanceType):\n        if len(InstanceType) == 0:\n            return \"您在当前区域无ecs实例\"\n        result = \"\"\n        for i in range(len(InstanceType)):\n            response = Application.call(\n                # 此处填写RAG应用的app_id\n                app_id='xxx',\n                prompt=f'介绍一下{InstanceType[i]}',\n                # 从环境变量中获取Dashscope的API Key\n                api_key=os.getenv(\"DASHSCOPE_API_KEY\"))\n            result += response.output.text\n        return result\n\nclass Billing:\n    # 无需输入，返回为阿里云账户余额信息\n    @classmethod\n    def get_balance(cls):\n        # 创建客户端\n        config = open_api_models.Config(\n            # 必填，请确保代码运行环境设置了环境变量 ALIBABA_CLOUD_ACCESS_KEY_ID。,\n            access_key_id=os.environ['ALIBABA_CLOUD_ACCESS_KEY_ID'],\n            # 必填，请确保代码运行环境设置了环境变量 ALIBABA_CLOUD_ACCESS_KEY_SECRET。,\n            access_key_secret=os.environ['ALIBABA_CLOUD_ACCESS_KEY_SECRET']\n        )\n        # Endpoint 请参考 https://api.aliyun.com/product/BssOpenApi\n        config.endpoint = f'business.aliyuncs.com'\n        runtime = util_models.RuntimeOptions()\n        client = BssOpenApi20171214Client(config)\n        balance_info = client.query_account_balance_with_options(runtime).body.data\n        return f\"\"\"币种为：{balance_info.currency}，可用额度为{balance_info.available_amount}，信控余额为{balance_info.credit_amount}，\n        网商余额为{balance_info.mybank_credit_amount}，现金余额为{balance_info.available_cash_amount}，生态客户Quota限额为{balance_info.quota_limit}。\"\"\"\n\nif __name__ == '__main__':\n    print(ECS.query_source('cn-hangzhou'))</code></pre></section><section id=\"dcdd6d7caaja3\" class=\"section\"><h3 id=\"aeedf988edl8c\"><b>main.py（用于创建<span class=\"help-letter-space\"></span>Agent<span class=\"help-letter-space\"></span>并定义交互方式）</b></h3><p id=\"112c90166cg8n\">main.py<span class=\"help-letter-space\"></span>主要作用为：</p><ol id=\"20c54563d1ing\"><li id=\"3ece864749pz5\"><p id=\"d4785c25926tb\"><a href=\"#500dd9f204hnn\" id=\"9c05d43c9c7ao\" title=\"\" class=\"xref\">创建<span class=\"help-letter-space\"></span>Agent</a></p></li><li id=\"d0eafb6d5dyji\"><p id=\"3f6307aaffffz\"><a href=\"#84ef33296e2m3\" id=\"3bd3df6d37h6i\" title=\"\" class=\"xref\">定义消息传递函数</a></p></li><li id=\"24cf318cd71j2\"><p id=\"4312d4dbfdwfk\"><a href=\"#6baccf59b53dl\" id=\"eed129f48600r\" title=\"\" class=\"xref\">定义<span class=\"help-letter-space\"></span>Agent<span class=\"help-letter-space\"></span>之间交互方式并获得回复</a></p></li><li id=\"448c6b55abbs0\"><p id=\"87a6993d007ak\"><a href=\"#f831f5a09cll1\" id=\"67bb92eb792zu\" title=\"\" class=\"xref\">前端展示界面</a></p></li></ol><p id=\"292cca3507omk\">其整体代码可见：<a href=\"#2e8890d4c02ko\" id=\"f5a0238e5272w\" title=\"\" class=\"xref\">main.py<span class=\"help-letter-space\"></span>整体代码</a>。</p><h4 id=\"5c16f7efabgut\"><b>引入依赖</b></h4><pre id=\"ec581b4610dbb\" code-type=\"xCode\" data-tag=\"codeblock\" outputclass=\"language-python\" props=\"china\" data-cond-props=\"china\" class=\"pre codeblock language-python\"><code>from dashscope import Assistants, Messages, Runs, Threads\nimport json\n# 从tools.py导入工具函数\nfrom tools import ECS,Billing\n# 引入前端界面展示依赖\nimport gradio as gr\n\n# 将列表形式的字符串解析为列表形式的数据，例如：\"['a','b']\"--&gt;['a','b']。\n# 用于将plannerassistant的输出解析为元素为assistant的列表\nimport ast</code></pre><h4 id=\"500dd9f204hnn\"><b>创建<span class=\"help-letter-space\"></span>Agent</b></h4><p id=\"bccb6b787ej2d\">本教程共包含五个<span class=\"help-letter-space\"></span>Agent，集成的工具函数与功能请见下表：</p><table id=\"07637da99blpi\" tablewidth=\"100\" tablecolswidth=\"33.96 25.83 40.21\" autofit=\"true\" class=\"table\"><colgroup colwidth=\"1.03*\" style=\"width:33.96%\"></colgroup><colgroup colwidth=\"0.78*\" style=\"width:25.83%\"></colgroup><colgroup colwidth=\"1.22*\" style=\"width:40.21%\"></colgroup><tbody class=\"tbody\"><tr id=\"d9f2659a7b0v7\"><td id=\"6fe5497fc7puz\" rowspan=\"1\" style=\"background-color:#e5e5e5\" colspan=\"1\"><p id=\"3a38b80620ruc\"><b>Agent<span class=\"help-letter-space\"></span>名称</b></p></td><td id=\"2e892dda7epg7\" rowspan=\"1\" style=\"background-color:#e5e5e5\" colspan=\"1\"><p id=\"95ef93f1c9i8a\"><b>集成的工具函数</b></p></td><td id=\"2481daa7916b2\" rowspan=\"1\" style=\"background-color:#e5e5e5\" colspan=\"1\"><p id=\"b1a97bc3df1gt\"><b>功能</b></p></td></tr><tr id=\"bfd87f261dtyl\"><td id=\"c41f6be6d1ox0\" rowspan=\"1\" style=\"background-color:rgba(0, 0, 0, 0)\" colspan=\"1\"><p id=\"9a0d3130e90b4\"><a href=\"#1003688998p0x\" id=\"724dd7a6599ev\" title=\"\" class=\"xref\">PlannerAssistant</a></p></td><td id=\"d6721d851c924\" rowspan=\"1\" style=\"background-color:rgba(0, 0, 0, 0)\" colspan=\"1\"><p id=\"9e09c52fd6yj0\">无</p></td><td id=\"96496a982dd10\" rowspan=\"1\" style=\"background-color:rgba(0, 0, 0, 0)\" colspan=\"1\"><p id=\"759effea32jv0\">对<span class=\"help-letter-space\"></span>Multi Agent<span class=\"help-letter-space\"></span>进行编排。</p></td></tr><tr id=\"216844f13cal8\"><td id=\"0cf7ec7418z5m\" rowspan=\"1\" style=\"background-color:rgba(0, 0, 0, 0)\" colspan=\"1\"><p id=\"5b70eabfbbb2r\"><a href=\"#f8193817d4mas\" id=\"719cf84e029zd\" title=\"\" class=\"xref\">ChatAssistant</a></p></td><td id=\"9fb27d85c9oo6\" rowspan=\"1\" style=\"background-color:rgba(0, 0, 0, 0)\" colspan=\"1\"><p id=\"67ec5e7b8bna7\">无</p></td><td id=\"cd19de3a28ybl\" rowspan=\"1\" style=\"background-color:rgba(0, 0, 0, 0)\" colspan=\"1\"><p id=\"0b6a1e54de0un\">如果无需使用工具，则使用该<span class=\"help-letter-space\"></span>Agent<span class=\"help-letter-space\"></span>进行回答。</p></td></tr><tr id=\"656579746cfcz\" style=\"height:68px\"><td id=\"2498209dfclzg\" rowspan=\"1\" style=\"background-color:rgba(0, 0, 0, 0)\" colspan=\"1\"><p id=\"6f1385f0dbnww\"><a href=\"#b15f21daf2xw3\" id=\"13d5146a5chy5\" title=\"\" class=\"xref\">AliyunInfoAssistant</a></p></td><td id=\"9a012422b968x\" rowspan=\"1\" style=\"background-color:rgba(0, 0, 0, 0)\" colspan=\"1\"><p id=\"907c93ac12c18\"><code data-tag=\"code\" code-type=\"xCode\" id=\"0fdae076f8xex\" class=\"code\">query_source</code>与<code data-tag=\"code\" code-type=\"xCode\" id=\"4cd5b73294r6o\" class=\"code\">get_balance</code></p></td><td id=\"657b945583qng\" rowspan=\"1\" style=\"background-color:rgba(0, 0, 0, 0)\" colspan=\"1\"><p id=\"d8dddad820okn\">查询阿里云的资源信息，包括<span class=\"help-letter-space\"></span>ECS<span class=\"help-letter-space\"></span>实例与阿里云余额。</p></td></tr><tr id=\"129082c2a38gi\" style=\"height:42px\"><td id=\"1faa7875bblus\" rowspan=\"1\" style=\"background-color:rgba(0, 0, 0, 0)\" colspan=\"1\"><p id=\"8828e02a08nrj\"><a href=\"#8908de55dd7kx\" id=\"5ae67ff70asru\" title=\"\" class=\"xref\">InstanceTypeDetailAssistant</a></p></td><td id=\"b2b7b91637l54\" rowspan=\"1\" style=\"background-color:rgba(0, 0, 0, 0)\" colspan=\"1\"><p id=\"0b1f28111e1jf\"><code data-tag=\"code\" code-type=\"xCode\" id=\"0d65c1f2c9nlg\" class=\"code\">call_agent_app</code></p></td><td id=\"b6f27e32c49a9\" rowspan=\"1\" style=\"background-color:rgba(0, 0, 0, 0)\" colspan=\"1\"><p id=\"2bf33ea1ca81n\">查询指定实例规格的指标数据。</p></td></tr><tr id=\"bb203d27d1wuw\"><td id=\"f8065cefd4dq1\" rowspan=\"1\" style=\"background-color:rgba(0, 0, 0, 0)\" colspan=\"1\"><p id=\"e58048bddd72x\"><a href=\"#1d19a35d6233s\" id=\"dd9db0ead39dk\" title=\"\" class=\"xref\">SummaryAssistant</a></p></td><td id=\"5b818d8de0hv6\" rowspan=\"1\" style=\"background-color:rgba(0, 0, 0, 0)\" colspan=\"1\"><p id=\"412698dec0tk9\">无</p></td><td id=\"d842c346edlb0\" rowspan=\"1\" style=\"background-color:rgba(0, 0, 0, 0)\" colspan=\"1\"><p id=\"fd39af99bfr8d\">结合前序<span class=\"help-letter-space\"></span>Agent<span class=\"help-letter-space\"></span>的输出，对用户问题进行全面、完整的回复。</p></td></tr></tbody></table><p id=\"76336e060dnj4\">五个<span class=\"help-letter-space\"></span>Agent<span class=\"help-letter-space\"></span>的详情如下：</p><div id=\"21585aceadt9a\" type=\"note\" class=\"note note-note\"><div class=\"note-icon-wrapper\"><i class=\"icon-note note note\"></i></div><div class=\"noteContentSpan\"><strong>说明 </strong><p id=\"223ae8b75b0i8\">Agent<span class=\"help-letter-space\"></span>中的大模型通过<span class=\"help-letter-space\"></span>Assistants.create<span class=\"help-letter-space\"></span>方法的<code data-tag=\"code\" code-type=\"xCode\" id=\"5c9bf04ddd0gx\" class=\"code\">model</code>参数定义；Agent<span class=\"help-letter-space\"></span>的功能由<span class=\"help-letter-space\"></span>Assistants.create<span class=\"help-letter-space\"></span>方法中的<code data-tag=\"code\" code-type=\"xCode\" id=\"31f3cb704ezev\" class=\"code\">tools</code>参数定义；您可以通过<span class=\"help-letter-space\"></span>Assistants.create<span class=\"help-letter-space\"></span>中的<code data-tag=\"code\" code-type=\"xCode\" id=\"e7fb422fe1s53\" class=\"code\">instructions</code>指引<span class=\"help-letter-space\"></span>Agent<span class=\"help-letter-space\"></span>使用工具的方式，以及<span class=\"help-letter-space\"></span>Agent<span class=\"help-letter-space\"></span>的输出格式等，例如让<span class=\"help-letter-space\"></span>Agent<span class=\"help-letter-space\"></span>以<span class=\"help-letter-space\"></span>JSON<span class=\"help-letter-space\"></span>格式输出字符串。具体实现代码请参考以下五个<span class=\"help-letter-space\"></span>Agent<span class=\"help-letter-space\"></span>的代码实现。</p></div></div><section id=\"b9e2c075e8qeh\" outputclass=\"tabbed-content-box\" data-tag=\"tabbed-content-box\" class=\"tabbed-content-box section\"><section id=\"d57b80abdc2ny\" class=\"section\"><h2 id=\"1003688998p0x\">PlannerAssistant</h2><p id=\"cb7d160953zq2\">PlannerAssistant<span class=\"help-letter-space\"></span>负责根据用户的输入与其它<span class=\"help-letter-space\"></span>agent<span class=\"help-letter-space\"></span>的功能，编排<span class=\"help-letter-space\"></span>Multi Agent<span class=\"help-letter-space\"></span>的工作方式，是<span class=\"help-letter-space\"></span>Multi Agent<span class=\"help-letter-space\"></span>的核心。在得到<span class=\"help-letter-space\"></span>PlannerAssistant<span class=\"help-letter-space\"></span>输出后，需要在后续程序中进行字符串解析，将其解析成列表形式的数据。代码如下：</p><pre code-type=\"xCode\" id=\"26cadf005dwqe\" data-tag=\"codeblock\" outputclass=\"language-python\" props=\"china\" data-cond-props=\"china\" class=\"pre codeblock language-python\"><code># 决策级别的agent，决定使用哪些agent，以及它们的运行顺序\nPlannerAssistant = Assistants.create(\n    # 因为该Agent作用比较重要，因此建议选择性能较强的大模型：qwen-plus。模型列表：https://help.aliyun.com/zh/model-studio/getting-started/models\n    model=\"qwen-plus\",\n    # 定义Agent的名称\n    name='流程编排机器人',\n    # 定义Agent的功能描述\n    description='你是团队的leader，你的手下有很多assistant，你需要根据用户的输入，决定要以怎样的顺序去使用这些assistant',\n    # 定义对Agent的指示语句，Agent会按照指示语句进行工具的调用并返回结果。\n    instructions=\"\"\"你的团队中有以下assistant。AliyunInfoAssistant：可以查询用户指定区域的阿里云ecs实例信息，或者查询用户的阿里云余额；InstanceTypeDetailAssistant：可以查询指定阿里云ecs实例规格的详细信息，比如cpu核数、内存大小等，可以一次查询多个实例规格信息，因此无需多次调用；\n    ChatAssistant：如果用户的问题无需以上两个assistant，则调用该assistant。你需要根据用户的问题，判断要以什么顺序使用这些assistant，你的返回形式是一个列表，不能返回其它信息。比如：[\"AliyunInfoAssistant\", \"AliyunInfoAssistant\",\"InstanceTypeDetailAssistant\"]或者[\"ChatAssistant\"]，列表中的元素只能为上述的assistant\"\"\"\n)</code></pre></section><section id=\"ce62b7688cbp1\" class=\"section\"><h2 id=\"f8193817d4mas\"><b>ChatAssistant</b></h2><p id=\"fa3d2eb879wcx\">ChatAssistant<span class=\"help-letter-space\"></span>的功能是回复日常问题，可以使用成本较低的模型（如<span class=\"help-letter-space\"></span>qwen-flash）作为<span class=\"help-letter-space\"></span>agent<span class=\"help-letter-space\"></span>的底座模型。</p><pre code-type=\"xCode\" id=\"e1600f79ebknd\" data-tag=\"codeblock\" outputclass=\"language-python\" class=\"pre codeblock language-python\"><code># 功能是回复日常问题。对于日常问题来说，可以使用价格较为低廉的模型作为agent的基座\nChatAssistant = Assistants.create(\n    # 因为该Agent对大模型性能要求不高，因此使用成本较低的qwen-flash模型\n    model=\"qwen-flash\",\n    name='回答日常问题的机器人',\n    description='一个智能助手，解答用户的问题',\n    instructions='请礼貌地回答用户的问题'\n)</code></pre></section><section id=\"27c17f24bfmz7\" class=\"section\"><h2 id=\"b15f21daf2xw3\"><b>AliyunInfoAssistant</b></h2><p id=\"f8bdd9704fmzf\">AliyunInfoAssistant<span class=\"help-letter-space\"></span>的功能是查询阿里云的资源信息。目前有<span class=\"help-letter-space\"></span>ecs<span class=\"help-letter-space\"></span>实例查询与阿里云余额查询两个功能。代码详情为：</p><pre code-type=\"xCode\" id=\"f31dd13356d46\" data-tag=\"codeblock\" outputclass=\"language-python\" props=\"china\" data-cond-props=\"china\" class=\"pre codeblock language-python\"><code># 功能是查询阿里云的资源信息。目前有ecs实例查询与阿里云余额查询两个功能\nAliyunInfoAssistant = Assistants.create(\n    model=\"qwen-plus\", # 模型列表：https://help.aliyun.com/zh/model-studio/getting-started/models\n    name='阿里云资源信息查询机器人',\n    description='一个智能助手，根据用户的查询去调用工具并返回查询到的阿里云资源结果',\n    instructions='你是一个智能助手，你有两个功能，分别是阿里云ecs实例信息查询和阿里云余额查询。请准确判断调用哪个工具，并礼貌地回答用户的问题。',\n    # 定义Agent使用的工具，您可以根据您的业务场景在tools列表中定义一个或多个Agent可能会使用的工具。\n    tools=[\n        {\n            'type': 'function',\n            'function': {\n                # 工具函数的名称，可通过下文代码中的function_mapper将name映射到函数本体\n                'name': 'ecs实例信息查询',\n                # 工具函数的描述\n                'description': '当需要查询阿里云ecs实例信息时非常有用，比如实例id，实例规格，收费信息等',\n                # 工具函数的入参\n                'parameters': {\n                    'type': 'object',\n                    'properties': {\n                        # 该工具需要用户输入地域信息\n                        'RegionID': {\n                            'type': 'str',\n                            # 参数的描述信息\n                            'description': '用户想要查询实例所属的地域id，如果是杭州，则为cn-hangzhou，如果是上海，则为cn-shanghai，如果是北京，则为cn-beijing'\n                        },\n                    },\n                    'required': ['RegionID']},\n            }\n        },\n        {\n            'type': 'function',\n            'function': {\n                'name': '阿里云余额查询',\n                # 工具函数的描述\n                'description': '当需要查询阿里云账户信息时非常有用',\n                # 工具函数的入参，余额查询无需入参，因此为空\n                'parameters': {}\n            }\n        }\n    ]\n)</code></pre></section><section id=\"dfb880c1552lo\" class=\"section\"><h2 id=\"8908de55dd7kx\"><b>InstanceTypeDetailAssistant</b></h2><p id=\"fb986d7c47nrb\">InstanceTypeDetailAssistant<span class=\"help-letter-space\"></span>接收<b>实例规格列表</b>信息，并通过<code data-tag=\"code\" code-type=\"xCode\" id=\"688216a158nzo\" class=\"code\">call_agent_app</code>函数将每一种实例规格对<span class=\"help-letter-space\"></span>RAG<span class=\"help-letter-space\"></span>应用进行查询，将每种实例规格返回的<span class=\"help-letter-space\"></span>vCPU<span class=\"help-letter-space\"></span>个数、内存大小等指标数据汇总作为输出。</p><pre code-type=\"xCode\" id=\"856420f500zod\" data-tag=\"codeblock\" outputclass=\"language-python\" props=\"china\" data-cond-props=\"china\" class=\"pre codeblock language-python\"><code># 功能是通过在阿里云百炼平台创建的RAG应用查询实例规格的详细信息\nInstanceTypeDetailAssistant = Assistants.create(\n    model=\"qwen-plus\", # 模型列表：https://help.aliyun.com/zh/model-studio/getting-started/models\n    name='ecs实例规格介绍机器人',\n    description='一个智能助手，可以通过用户提供的实例规格，调用已有的插件能力给用户介绍实例规格信息。',\n    instructions='你是一个智能助手，你需要从输入中精确提取出实例规格信息，如[ecs.e-c1m1.large]，或[ecs.u1-c1m4.xlarge,ecs.e-c1m1.large]。将实例规格列表输入工具中，获得它们的详细信息',\n    tools=[\n        {\n            'type': 'function',\n            'function': {\n                'name': 'ecs实例规格介绍',\n                'description': '返回客户查询指定ecs实例规格的信息',\n                'parameters': {\n                    'type': 'object',\n                    'properties': {\n                        'InstanceType': {\n                            'type': 'list',\n                            'InstanceType': '用户想要查询的实例规格，有可能是一个，有可能是多个，如：[ecs.e-c1m1.large]，或[ecs.u1-c1m4.xlarge,ecs.e-c1m1.large]'\n                        },\n                    },\n                    'required': ['InstanceType']},\n            }\n        }\n    ]\n)</code></pre></section><section id=\"d27381a4d9o8e\" class=\"section\"><h2 id=\"1d19a35d6233s\">SummaryAssistant</h2><p id=\"659e7c24611ae\">每一个<span class=\"help-letter-space\"></span>Agent<span class=\"help-letter-space\"></span>都会有输出信息，因此需要一个用于总结的<span class=\"help-letter-space\"></span>Agent<span class=\"help-letter-space\"></span>将前序的<span class=\"help-letter-space\"></span>Agent<span class=\"help-letter-space\"></span>输出信息进行总结，从而对用户的问题进行全面、完整的回答。代码详情如下：</p><pre code-type=\"xCode\" id=\"e397eb7b95p3a\" data-tag=\"codeblock\" outputclass=\"language-python\" props=\"china\" data-cond-props=\"china\" class=\"pre codeblock language-python\"><code># 在Multi Agent场景下，定义一个用于总结的Agent，该Agent会根据用户的问题与之前Agent输出的参考信息，全面、完整地回答用户问题\nSummaryAssistant = Assistants.create(\n    model=\"qwen-plus\", # 模型列表：https://help.aliyun.com/zh/model-studio/getting-started/models\n    name='总结机器人',\n    description='一个智能助手，根据用户的问题与参考信息，全面、完整地回答用户问题',\n    instructions='你是一个智能助手，根据用户的问题与参考信息，全面、完整地回答用户问题'\n)\n</code></pre></section></section><h4 id=\"02e5c730a46hq\">定义字符串与函数、字符串与<span class=\"help-letter-space\"></span>Agent<span class=\"help-letter-space\"></span>本体的映射</h4><p id=\"b6c60c4a14xsh\">由于大模型生成的是字符串形式的结果，因此我们在程序中需要对大模型生成的字符串进行解析、映射等操作，以达到和外界交互的功能。</p><pre id=\"33e353637cat7\" code-type=\"xCode\" data-tag=\"codeblock\" outputclass=\"language-python\" class=\"pre codeblock language-python\"><code># 将工具函数的name映射到函数本体\nfunction_mapper = {\n    \"ecs实例信息查询\": ECS.query_source,\n    \"ecs实例规格介绍\":ECS.call_agent_app,\n    \"阿里云余额查询\":Billing.get_balance\n}\n# 将Agent的name映射到Agent本体\nassistant_mapper = {\n    \"ChatAssistant\": ChatAssistant,\n    \"AliyunInfoAssistant\":AliyunInfoAssistant,\n    \"InstanceTypeDetailAssistant\":InstanceTypeDetailAssistant\n}</code></pre><h4 id=\"84ef33296e2m3\"><b>定义消息传递函数</b></h4><p id=\"655193c758ysz\">消息传递函数<code data-tag=\"code\" code-type=\"xCode\" id=\"7be08fac5c87t\" class=\"code\">get_agent_response</code>接收<span class=\"help-letter-space\"></span>assistant<span class=\"help-letter-space\"></span>与<span class=\"help-letter-space\"></span>message<span class=\"help-letter-space\"></span>两个参数，用于获得指定<span class=\"help-letter-space\"></span>Agent<span class=\"help-letter-space\"></span>在接收到输入<span class=\"help-letter-space\"></span>message<span class=\"help-letter-space\"></span>时的输出信息。</p><pre code-type=\"xCode\" id=\"3b2d291b5ew7q\" data-tag=\"codeblock\" outputclass=\"language-python\" class=\"pre codeblock language-python\"><code># 输入message信息，输出为指定Agent的回复\ndef get_agent_response(assistant, message=''):\n    # 打印出输入Agent的信息\n    print(f\"Query: {message}\")\n    thread = Threads.create()\n    message = Messages.create(thread.id, content=message)\n    run = Runs.create(thread.id, assistant_id=assistant.id)\n    run_status = Runs.wait(run.id, thread_id=thread.id)\n    # 如果响应失败，会打印出run failed\n    if run_status.status == 'failed':\n        print('run failed:')\n    # 如果需要工具来辅助大模型输出，则进行以下流程\n    if run_status.required_action:\n        f = run_status.required_action.submit_tool_outputs.tool_calls[0].function\n        # 获得function name\n        func_name = f['name']\n        # 获得function 的入参\n        param = json.loads(f['arguments'])\n        # 打印出工具信息\n        print(\"function is\",f)\n        # 根据function name，通过function_mapper映射到函数，并将参数输入工具函数得到output输出\n        if func_name in function_mapper:\n            output = function_mapper[func_name](**param)\n        else:    \n            output = \"\"\n        tool_outputs = [{\n            'output':\n                output\n        }]\n        run = Runs.submit_tool_outputs(run.id,\n                                       thread_id=thread.id,\n                                       tool_outputs=tool_outputs)\n        run_status = Runs.wait(run.id, thread_id=thread.id)\n    run_status = Runs.get(run.id, thread_id=thread.id)\n    msgs = Messages.list(thread.id)\n    # 将Agent的输出返回\n    return msgs['data'][0]['content'][0]['text']['value']</code></pre></section><h4 id=\"6baccf59b53dl\"><b>定义<span class=\"help-letter-space\"></span>Agent<span class=\"help-letter-space\"></span>之间交互方式并获得回复</b></h4><p id=\"d99f4771f3itn\">Agent<span class=\"help-letter-space\"></span>之间的交互步骤根据<span class=\"help-letter-space\"></span><a href=\"#1003688998p0x\" id=\"843681648bwoo\" title=\"\" class=\"xref\">PlannerAssistant</a><span class=\"help-letter-space\"></span>进行编排，为了适配<span class=\"help-letter-space\"></span>Gradio<span class=\"help-letter-space\"></span>的前端界面展示，输入输出的参数需要与<span class=\"help-letter-space\"></span>Gradio<span class=\"help-letter-space\"></span>中的组件进行对齐。代码如下：</p><div id=\"e0b6208a3frl2\" type=\"note\" class=\"note note-note\"><div class=\"note-icon-wrapper\"><i class=\"icon-note note note\"></i></div><div class=\"noteContentSpan\"><strong>说明 </strong><p id=\"d8a53f222brke\">使用<code data-tag=\"code\" class=\"code blog-code\" code-type=\"xCode\" id=\"1b88abb657db9\">yield</code>关键字而不是<code data-tag=\"code\" class=\"code blog-code\" code-type=\"xCode\" id=\"bb7a086ba44pa\">return</code>，可以迭代地生成和返回中间结果。这样，中间结果可以逐步传递给前端界面，实现实时显示，而不必等到所有结果生成后再显示。</p></div></div><pre id=\"83d0d80fabc11\" code-type=\"xCode\" data-tag=\"codeblock\" outputclass=\"language-python\" class=\"pre codeblock language-python\"><code># 获得Multi Agent的回复，输入与输出需要与Gradio前端展示界面中的参数对齐\ndef get_multi_agent_response(query,history):\n    # 处理输入为空的情况\n    if len(query) == 0:\n        return \"\",history+[(\"\",\"\")],\"\",\"\"\n    # 获取Agent的运行顺序\n    assistant_order = get_agent_response(PlannerAssistant,query)\n    try:\n        order_stk = ast.literal_eval(assistant_order)\n        cur_query = query\n        Agent_Message = \"\"\n        # 依次运行Agent\n        for i in range(len(order_stk)):\n            yield \"-----&gt;\".join(order_stk),history+[(query,\"multi agent正在努力工作中...\")],Agent_Message+'\\n'+f\"*{order_stk[i]}*正在处理中...\",\"\"\n            cur_assistant = assistant_mapper[order_stk[i]]\n            response = get_agent_response(cur_assistant,cur_query)\n            Agent_Message += f\"*{order_stk[i]}*的回复为：{response}\\n\\n\"\n            yield \"-----&gt;\".join(order_stk),history+[(query,\"multi agent正在努力工作中...\")],Agent_Message,\"\"\n            # 如果当前Agent为最后一个Agent，则将其输出作为Multi Agent的输出\n            if i == len(order_stk)-1:\n                prompt = f\"请参考已知的信息：{Agent_Message}，回答用户的问题：{query}。\"\n                multi_agent_response = get_agent_response(SummaryAssistant,prompt)\n                yield \"-----&gt;\".join(order_stk),history+[(query,multi_agent_response)],Agent_Message,\"\"\n            # 如果当前Agent不是最后一个Agent，则将上一个Agent的输出response添加到下一轮的query中，作为参考信息\n            else:\n                # 在参考信息前后加上特殊标识符，可以防止大模型混淆参考信息与提问\n                cur_query = f\"你可以参考已知的信息：{response}你要完整地回答用户的问题。问题是：{query}。\"\n    # 兜底策略，如果上述程序运行失败，则直接调用ChatAssistant\n    except Exception as e:\n        yield \"ChatAssistant\",[(query,get_agent_response(ChatAssistant,query))],\"\",\"\"\n</code></pre><p id=\"a61f0bd98aynb\">输入参数为<span class=\"help-letter-space\"></span>query<span class=\"help-letter-space\"></span>与<span class=\"help-letter-space\"></span>history。其中<span class=\"help-letter-space\"></span>query<span class=\"help-letter-space\"></span>为用户的提问（字符串形式），history<span class=\"help-letter-space\"></span>为用户与<span class=\"help-letter-space\"></span>Multi Agent<span class=\"help-letter-space\"></span>的对话记录（列表形式）。</p><p id=\"11edf67a0elut\">第一个输出参数为<span class=\"help-letter-space\"></span>Agent<span class=\"help-letter-space\"></span>的编排信息（字符串形式），第二个输出参数为用户与<span class=\"help-letter-space\"></span>Multi Agent<span class=\"help-letter-space\"></span>的对话历史（列表形式），第三个输出参数为当前运行<span class=\"help-letter-space\"></span>Agent<span class=\"help-letter-space\"></span>的状态（字符串形式），为了适配<span class=\"help-letter-space\"></span>Gradio<span class=\"help-letter-space\"></span>组件，第四个输出参数为用户的输入框（字符串形式，设为<code data-tag=\"code\" code-type=\"xCode\" id=\"455c00d08cyo8\" class=\"code\">\"\"</code>以达到用户发起提问后将输入框清空的效果）。</p><h4 id=\"f831f5a09cll1\">前端展示界面</h4><p id=\"18a4f1b009tyu\">本教程使用<span class=\"help-letter-space\"></span>gradio<span class=\"help-letter-space\"></span>作为前端展示工具。gradio<span class=\"help-letter-space\"></span>可以快速帮助机器学习工作者创建模型效果展示界面，代码详情如下：</p><pre id=\"3808fbe68f4yn\" code-type=\"xCode\" data-tag=\"codeblock\" outputclass=\"language-python\" class=\"pre codeblock language-python\"><code># 前端界面展示\nwith gr.Blocks() as demo:\n    # 在界面中央展示标题\n    gr.HTML('&lt;center&gt;&lt;h1&gt;欢迎使用阿里云资源查询bot&lt;/h1&gt;&lt;/center&gt;')\n    gr.HTML('&lt;center&gt;&lt;h3&gt;支持的功能有指定区域的ecs实例查询、余额查询、实例规格详情查询。您可以在tools.py中添加您需要的工具，并在main.py中配置相关的agent&lt;/h3&gt;&lt;/center&gt;')\n    with gr.Row():\n        with gr.Column(scale=10):\n            chatbot = gr.Chatbot(value=[[\"hello\",\"很高兴见到您！您想问关于阿里云资源的哪些问题呢？\"]],height=600)\n        with gr.Column(scale=4):\n            text1 = gr.Textbox(label=\"assistant选择\")\n            text2 = gr.Textbox(label=\"当前assistant状态\",lines=22)\n    with gr.Row():\n        msg = gr.Textbox(label=\"输入\",placeholder=\"您想了解什么呢？\")\n    # 一些示例问题\n    with gr.Row():\n        examples = gr.Examples(examples=[\n            '我的阿里云余额还有多少钱啊',\n            '我在杭州有哪些ecs实例，把它的实例id，价钱以及实例规格详情告诉我',\n            '我想了解ecs.u1-c1m4.xlarge和ecs.gn6i-c4g1.xlarge的指标'],inputs=[msg])\n    clear = gr.ClearButton([text1,chatbot,text2,msg])\n    msg.submit(get_multi_agent_response, [msg,chatbot], [text1,chatbot,text2,msg])</code></pre><h4 id=\"2e8890d4c02ko\"><code data-tag=\"code\" code-type=\"xCode\" id=\"113507760eg6v\" class=\"code\"><b>main.py</b></code><b>整体代码</b></h4><pre id=\"b1110b118ajx1\" code-type=\"xCode\" data-tag=\"codeblock\" outputclass=\"language-python\" props=\"china\" data-cond-props=\"china\" class=\"pre codeblock language-python\"><code>from dashscope import Assistants, Messages, Runs, Threads\nimport json\n# 从tools.py导入工具函数\nfrom tools import ECS,Billing\n# 引入前端界面展示依赖\nimport gradio as gr\nimport ast\n\n# 决策级别的agent，决定使用哪些agent，以及它们的运行顺序\nPlannerAssistant = Assistants.create(\n    # 因为该Agent作用比较重要，因此建议选择性能较强的大模型：qwen-plus。模型列表：https://help.aliyun.com/zh/model-studio/getting-started/models\n    model=\"qwen-plus\",\n    # 定义Agent的名称\n    name='流程编排机器人',\n    # 定义Agent的功能描述\n    description='你是团队的leader，你的手下有很多assistant，你需要根据用户的输入，决定要以怎样的顺序去使用这些assistant',\n    # 定义对Agent的指示语句，Agent会按照指示语句进行工具的调用并返回结果。\n    instructions=\"\"\"你的团队中有以下assistant。AliyunInfoAssistant：可以查询用户指定区域的阿里云ecs实例信息，或者查询用户的阿里云余额；InstanceTypeDetailAssistant：可以查询指定阿里云ecs实例规格的详细信息，比如cpu核数、内存大小等，可以一次查询多个实例规格信息，因此无需多次调用；\n    ChatAssistant：如果用户的问题无需以上两个assistant，则调用该assistant。你需要根据用户的问题，判断要以什么顺序使用这些assistant，你的返回形式是一个列表，不能返回其它信息。比如：[\"AliyunInfoAssistant\", \"AliyunInfoAssistant\",\"InstanceTypeDetailAssistant\"]或者[\"ChatAssistant\"]，列表中的元素只能为上述的assistant\"\"\"\n)\n\n# 功能是回复日常问题。对于日常问题来说，可以使用价格较为低廉的模型作为agent的基座\nChatAssistant = Assistants.create(\n    # 因为该Agent对大模型性能要求不高，因此使用成本较低的qwen-flash模型。模型列表：https://help.aliyun.com/zh/model-studio/getting-started/models\n    model=\"qwen-flash\",\n    name='回答日常问题的机器人',\n    description='一个智能助手，解答用户的问题',\n    instructions='请礼貌地回答用户的问题'\n)\n\n# 功能是查询阿里云的资源信息。目前有ECS实例查询与阿里云余额查询两个功能\nAliyunInfoAssistant = Assistants.create(\n    model=\"qwen-plus\",  # 模型列表：https://help.aliyun.com/zh/model-studio/getting-started/models\n    name='阿里云资源信息查询机器人',\n    description='一个智能助手，根据用户的查询去调用工具并返回查询到的阿里云资源结果',\n    instructions='你是一个智能助手，你有两个功能，分别是阿里云ecs实例信息查询和阿里云余额查询。请准确判断调用哪个工具，并礼貌地回答用户的问题。',\n    # 定义Agent使用的工具，您可以根据您的业务场景在tools列表中定义一个或多个Agent可能会使用的工具。\n    tools=[\n        {\n            'type': 'function',\n            'function': {\n                # 工具函数的名称，可通过下文代码中的function_mapper将name映射到函数本体\n                'name': 'ecs实例信息查询',\n                # 工具函数的描述\n                'description': '当需要查询阿里云ecs实例信息时非常有用，比如实例id，实例规格，收费信息等',\n                # 工具函数的入参\n                'parameters': {\n                    'type': 'object',\n                    'properties': {\n                        # 该工具需要用户输入地域信息\n                        'RegionID': {\n                            'type': 'str',\n                            # 参数的描述信息\n                            'description': '用户想要查询实例所属的地域id，如果是杭州，则为cn-hangzhou，如果是上海，则为cn-shanghai，如果是北京，则为cn-beijing'\n                        },\n                    },\n                    'required': ['RegionID']},\n            }\n        },\n        {\n            'type': 'function',\n            'function': {\n                'name': '阿里云余额查询',\n                # 工具函数的描述\n                'description': '当需要查询阿里云账户信息时非常有用',\n                # 工具函数的入参，余额查询无需入参，因此为空\n                'parameters': {}\n            }\n        }\n    ]\n)\n\n# 功能是通过在阿里云百炼平台创建的RAG应用查询实例规格的详细信息\nInstanceTypeDetailAssistant = Assistants.create(\n    model=\"qwen-plus\",  # 模型列表：https://help.aliyun.com/zh/model-studio/getting-started/models\n    name='ecs实例规格介绍机器人',\n    description='一个智能助手，可以通过用户提供的输入，精确识别提到的实例规格。调用已有的插件能力给用户介绍实例规格信息。',\n    instructions='你是一个智能助手，你需要从用户的输入中精确识别提取出阿里云的实例规格信息，如[ecs.e-c1m1.large]，或[ecs.u1-c1m4.xlarge,ecs.e-c1m1.large]。将实例规格列表输入工具中，获得它们的详细信息',\n    tools=[\n        {\n            'type': 'function',\n            'function': {\n                'name': 'ecs实例规格介绍',\n                'description': '返回客户查询指定ecs实例规格的信息',\n                'parameters': {\n                    'type': 'object',\n                    'properties': {\n                        'InstanceType': {\n                            'type': 'list',\n                            'InstanceType': '用户想要查询的实例规格，有可能是一个，有可能是多个，如：[ecs.e-c1m1.large]，或[ecs.u1-c1m4.xlarge,ecs.e-c1m1.large]'\n                        },\n                    },\n                    'required': ['InstanceType']},\n            }\n        }\n    ]\n)\n\n# 在Multi Agent场景下，定义一个用于总结的Agent，该Agent会根据用户的问题与之前Agent输出的参考信息，全面、完整地回答用户问题\nSummaryAssistant = Assistants.create(\n    model=\"qwen-plus\",  # 模型列表：https://help.aliyun.com/zh/model-studio/getting-started/models\n    name='总结机器人',\n    description='一个智能助手，根据用户的问题与参考信息，全面、完整地回答用户问题',\n    instructions='你是一个智能助手，根据用户的问题与参考信息，全面、完整地回答用户问题'\n)\n\n# 将工具函数的name映射到函数本体\nfunction_mapper = {\n    \"ecs实例信息查询\": ECS.query_source,\n    \"ecs实例规格介绍\":ECS.call_agent_app,\n    \"阿里云余额查询\":Billing.get_balance\n}\n# 将Agent的name映射到Agent本体\nassistant_mapper = {\n    \"ChatAssistant\": ChatAssistant,\n    \"AliyunInfoAssistant\":AliyunInfoAssistant,\n    \"InstanceTypeDetailAssistant\":InstanceTypeDetailAssistant\n}\n\n# 输入message信息，输出为指定Agent的回复\ndef get_agent_response(assistant, message=''):\n    # 打印出输入Agent的信息\n    print(f\"Query: {message}\")\n    thread = Threads.create()\n    message = Messages.create(thread.id, content=message)\n    run = Runs.create(thread.id, assistant_id=assistant.id)\n    run_status = Runs.wait(run.id, thread_id=thread.id)\n    # 如果响应失败，会打印出run failed\n    if run_status.status == 'failed':\n        print('run failed:')\n    # 如果需要工具来辅助大模型输出，则进行以下流程\n    if run_status.required_action:\n        f = run_status.required_action.submit_tool_outputs.tool_calls[0].function\n        # 获得function name\n        func_name = f['name']\n        # 获得function 的入参\n        param = json.loads(f['arguments'])\n        # 打印出工具信息\n        print(\"function is\",f)\n        # 根据function name，通过function_mapper映射到函数，并将参数输入工具函数得到output输出\n        if func_name in function_mapper:\n            output = function_mapper[func_name](**param)\n        else:    \n            output = \"\"\n        tool_outputs = [{\n            'output':\n                output\n        }]\n        run = Runs.submit_tool_outputs(run.id,\n                                       thread_id=thread.id,\n                                       tool_outputs=tool_outputs)\n        run_status = Runs.wait(run.id, thread_id=thread.id)\n    run_status = Runs.get(run.id, thread_id=thread.id)\n    msgs = Messages.list(thread.id)\n    # 将Agent的输出返回\n    return msgs['data'][0]['content'][0]['text']['value']\n\n# 获得Multi Agent的回复，输入与输出需要与Gradio前端展示界面中的参数对齐\ndef get_multi_agent_response(query,history):\n    # 处理输入为空的情况\n    if len(query) == 0:\n        return \"\",history+[(\"\",\"\")],\"\",\"\"\n    # 获取Agent的运行顺序\n    assistant_order = get_agent_response(PlannerAssistant,query)\n    try:\n        order_stk = ast.literal_eval(assistant_order)\n        cur_query = query\n        Agent_Message = \"\"\n        # 依次运行Agent\n        for i in range(len(order_stk)):\n            yield \"-----&gt;\".join(order_stk),history+[(query,\"multi agent正在努力工作中...\")],Agent_Message+'\\n'+f\"*{order_stk[i]}*正在处理中...\",\"\"\n            cur_assistant = assistant_mapper[order_stk[i]]\n            response = get_agent_response(cur_assistant,cur_query)\n            Agent_Message += f\"*{order_stk[i]}*的回复为：{response}\\n\\n\"\n            yield \"-----&gt;\".join(order_stk),history+[(query,\"multi agent正在努力工作中...\")],Agent_Message,\"\"\n            # 如果当前Agent为最后一个Agent，则将其输出作为Multi Agent的输出\n            if i == len(order_stk)-1:\n                prompt = f\"请参考已知的信息：{Agent_Message}，回答用户的问题：{query}。\"\n                multi_agent_response = get_agent_response(SummaryAssistant,prompt)\n                yield \"-----&gt;\".join(order_stk),history+[(query,multi_agent_response)],Agent_Message,\"\"\n            # 如果当前Agent不是最后一个Agent，则将上一个Agent的输出response添加到下一轮的query中，作为参考信息\n            else:\n                # 在参考信息前后加上特殊标识符，可以防止大模型混淆参考信息与提问\n                cur_query = f\"你可以参考已知的信息：{response}你要完整地回答用户的问题。问题是：{query}。\"\n    # 兜底策略，如果上述程序运行失败，则直接调用ChatAssistant\n    except Exception as e:\n        yield \"ChatAssistant\",[(query,get_agent_response(ChatAssistant,query))],\"\",\"\"\n\n\n# 前端界面展示\nwith gr.Blocks() as demo:\n    # 在界面中央展示标题\n    gr.HTML('&lt;center&gt;&lt;h1&gt;欢迎使用阿里云资源查询bot&lt;/h1&gt;&lt;/center&gt;')\n    gr.HTML('&lt;center&gt;&lt;h3&gt;支持的功能有指定区域的ecs实例查询、余额查询、实例规格详情查询。您可以在tools.py中添加您需要的工具，并在main.py中配置相关的agent&lt;/h3&gt;&lt;/center&gt;')\n    with gr.Row():\n        with gr.Column(scale=10):\n            chatbot = gr.Chatbot(value=[[\"hello\",\"很高兴见到您！您想问关于阿里云资源的哪些问题呢？\"]],height=600)\n        with gr.Column(scale=4):\n            text1 = gr.Textbox(label=\"assistant选择\")\n            text2 = gr.Textbox(label=\"当前assistant状态\",lines=22)\n    with gr.Row():\n        msg = gr.Textbox(label=\"输入\",placeholder=\"您想了解什么呢？\")\n    # 一些示例问题\n    with gr.Row():\n        examples = gr.Examples(examples=[\n            '我的阿里云余额还有多少钱啊',\n            '我在杭州有哪些ecs实例，把它的实例id，价钱以及实例规格详情告诉我',\n            '我想了解ecs.u1-c1m4.xlarge和ecs.gn6i-c4g1.xlarge的指标'],inputs=[msg])\n    clear = gr.ClearButton([text1,chatbot,text2,msg])\n    msg.submit(get_multi_agent_response, [msg,chatbot], [text1,chatbot,text2,msg])\n\nif __name__ == '__main__':\n    demo.launch()\n</code></pre><h3 id=\"00685b35celja\">运行效果</h3><p id=\"31f7d6b5a07zf\">请您在配置<code data-tag=\"code\" code-type=\"xCode\" id=\"6a89c067e1sn7\" class=\"code\">ALIBABA_CLOUD_ACCESS_KEY_ID</code>、<code data-tag=\"code\" code-type=\"xCode\" id=\"04e72f5e2c177\" class=\"code\">ALIBABA_CLOUD_ACCESS_KEY_SECRET</code>和<code data-tag=\"code\" code-type=\"xCode\" id=\"3bb20e7cf1mvn\" class=\"code\">DASHSCOPE_API_KEY</code>到环境变量后，运行<code data-tag=\"code\" code-type=\"xCode\" id=\"2319ec9de2wvz\" class=\"code\">main.py</code>文件。终端页面会有<code data-tag=\"code\" code-type=\"xCode\" id=\"2984cc9b5eqne\" class=\"code\">Running on local URL:</code> 的输出，访问对应<span class=\"help-letter-space\"></span>URL，进入交互界面。输入：<span data-tag=\"code\" code-type=\"xCode\" props=\"china\" id=\"ea1da606aaj0t\" data-cond-props=\"china\" class=\"code\">我想知道我在杭州的<span class=\"help-letter-space\"></span>ecs<span class=\"help-letter-space\"></span>实例，还有我的阿里云余额</span>，或者单击<span class=\"help-letter-space\"></span><b data-tag=\"uicontrol\" id=\"25e17c64454z0\" class=\"uicontrol\">Examples</b><span class=\"help-letter-space\"></span>中的示例问题，将其添加到输入框中，并单击<span class=\"help-letter-space\"></span>Enter，等待结果的生成。您可以观察<b data-tag=\"uicontrol\" id=\"d0885ecd65joz\" class=\"uicontrol\">当前<span class=\"help-letter-space\"></span>assistant<span class=\"help-letter-space\"></span>状态</b>框来查看<span class=\"help-letter-space\"></span>Agent<span class=\"help-letter-space\"></span>的实时状态。<img id=\"f1670254832uw\" src=\"https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/9873322271/p824552.png\" alt=\"image\" placement=\"break\" width=\"800\" props=\"china\" data-cond-props=\"china\" class=\"image break\"></p><p id=\"fed40344bfkrr\"></p></section><section id=\"ffcbcc6d18htl\" class=\"section\"><h2 id=\"5ae32ee9catxg\"><b>总结</b></h2><p id=\"61b67dd834y7w\">通过本教程，您可以了解到将阿里云百炼<span class=\"help-letter-space\"></span>RAG<span class=\"help-letter-space\"></span>应用与阿里云的<span class=\"help-letter-space\"></span>OpenAPI<span class=\"help-letter-space\"></span>能力集成到<span class=\"help-letter-space\"></span>Agent<span class=\"help-letter-space\"></span>中的方式，以及使用阿里云百炼平台的<span class=\"help-letter-space\"></span>Assistants API<span class=\"help-letter-space\"></span>进行<span class=\"help-letter-space\"></span>Multi Agent<span class=\"help-letter-space\"></span>开发的步骤，并最终通过基于<span class=\"help-letter-space\"></span>Gradio<span class=\"help-letter-space\"></span>的前端界面展示出来。</p><p id=\"a3d93d32a3b1m\">您可以通过修改<span class=\"help-letter-space\"></span>Agent<span class=\"help-letter-space\"></span>中的提示词、细化<span class=\"help-letter-space\"></span>Agent<span class=\"help-letter-space\"></span>之间的交互方式、修改工具函数等方法，将<span class=\"help-letter-space\"></span>Multi Agent<span class=\"help-letter-space\"></span>应用到您的业务中。</p></section></div></main>\n\n</div>","path":"https://help.aliyun.com/zh/model-studio/use-multi-agent-to-query-alibaba-cloud-resource-information","productNodeVO":{"emptyNode":false,"level":3,"validDocument":true,"headNavEnable":false,"docTitle":"大模型服务平台百炼","id":2400256,"title":"大模型服务平台百炼","url":"/zh/model-studio/"},"alias":"/model-studio/use-multi-agent-to-query-alibaba-cloud-resource-information","showType":1,"taskStatus":"NO_TASK_AVAILABLE","website":"cn","level":6,"developerUrl":"https://developer.aliyun.com/modelstudio/","nodeType":1,"version":18,"url":"/zh/model-studio/use-multi-agent-to-query-alibaba-cloud-resource-information","tags":[{"value":"1","key":"accept","desc":"已承接"},{"value":false,"key":"autoTranslation","desc":"非自动翻译"},{"value":2797088,"key":"nodeId","desc":"文档ID"}],"userVO":{},"recommendDocs":[],"directoryPath":{"children":[{"children":[{"emptyNode":false,"level":6,"validDocument":true,"headNavEnable":false,"docTitle":"用Assistant API构建Multi-Agent","id":2797088,"title":"用Assistant API构建Multi-Agent","url":"/zh/model-studio/use-multi-agent-to-query-alibaba-cloud-resource-information"}],"emptyNode":false,"level":5,"validDocument":true,"headNavEnable":false,"docTitle":"实践教程","id":2400263,"title":"实践教程","url":"/zh/model-studio/use-cases/"}],"emptyNode":false,"level":3,"validDocument":true,"headNavEnable":false,"docTitle":"大模型服务平台百炼","id":2400256,"title":"大模型服务平台百炼","url":"/zh/model-studio/"},"productUrl":"https://www.aliyun.com/product/bailian","nodeId":2797088,"desc":"本文教您如何使用Assistant API构建可自动规划任务的Multi-Agent系统，通过提供详细步骤与完整Python代码，助您快速实现阿里云资源查询。"},"breadcrumb":[{"emptyNode":false,"level":3,"validDocument":true,"headNavEnable":false,"docTitle":"大模型服务平台百炼","id":2400256,"title":"大模型服务平台百炼","url":"/zh/model-studio/"},{"emptyNode":false,"level":5,"validDocument":true,"headNavEnable":false,"docTitle":"实践教程","id":2400263,"title":"实践教程","url":"/zh/model-studio/use-cases/"},{"emptyNode":false,"level":6,"validDocument":true,"headNavEnable":false,"docTitle":"用Assistant API构建Multi-Agent","id":2797088,"title":"用Assistant API构建Multi-Agent","url":"/zh/model-studio/use-multi-agent-to-query-alibaba-cloud-resource-information"}],"isMachineTranslation":false,"isNotFound":false,"helpResponseCode":200,"redirectUrl":"","helpDocVersion":1,"reloadFlag":true}}};
  </script><link href="https://g.alicdn.com/code/npm/@ali??hmod-ace-2023-box/0.1.0/index.css,hmod-aliyun-com-global-nav-search/0.7.13/index.css,hmod-aliyun-com-global-nav/0.2.50/index.css" rel="stylesheet"/>
<link href="https://g.alicdn.com/code/npm/@ali??hmod-ace-2023-box/0.1.0/index.css,hmod-ace-2024-global-footer/0.1.2/index.css" rel="stylesheet"/>
</head>

<body><script>
with(document)with(body)with(insertBefore(createElement("script"),firstChild))setAttribute("exparams","category=&userid=&aplus&yunid=&&trid=2150421617679238928637612ead48&asid=AQAAAAC1YGBpXw9fRgAAAAC/AxV5tUDqqQ==",id="tb-beacon-aplus",src=(location>"https"?"//g":"//g")+".alicdn.com/alilog/mlog/aplus_v2.js")
</script>

  <header><div id="ccd960598cacfbfb0b6848d42529a646"><div class="_18a32969382a277c44015217fbc5cb5a_box"><div class="c97dc5fe8c8f69b0e60edf6a1f709489_pc de5ef2fee09ebcb2b1dcaf0c982523bc_theme bdac01e7d42089a1161e0315c2a68512_reset" data-ai-assistant-text-selection-tooltip="disabled"><header class="b62a767265ae40ce4e5e07aa2336b1be_container   "><button class="_17fcaf1a4ee37405e5ad5fbad24204b4_container _17fcaf1a4ee37405e5ad5fbad24204b4_loading" aria-label="打开菜单" data-spm="d_dashboard_trigger" data-tracker-exp="true"><span class="_17fcaf1a4ee37405e5ad5fbad24204b4_burger "><span class="_17fcaf1a4ee37405e5ad5fbad24204b4_middle"></span></span></button><a href="https://www.aliyun.com/" class="_3f46140aade30bc61f3012933357c477_logo b62a767265ae40ce4e5e07aa2336b1be_logo" data-tracker-content="LOGO" data-spm="d_logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 4608 1024" fill="#ff6a00" width="80"><path d="M3266.56 773.12h327.68v-102.4h-327.68v-102.4H3584V35.84H2846.72v532.48h317.44v102.4h-327.68v102.4h327.68v112.64h-353.28v102.4h814.08v-102.4h-353.28v-112.64zM3276.8 138.24h215.04v112.64H3276.8V138.24z m0 215.04h215.04V460.8H3276.8V353.28zM3174.4 460.8h-215.04V353.28H3174.4V460.8z m0-209.92h-215.04V138.24H3174.4v112.64zM537.6 445.44H1075.2v122.88H537.6z"></path><path d="M1341.44 5.12h-353.28L1075.2 128l256 81.92c46.08 15.36 76.8 61.44 76.8 107.52v389.12c0 46.08-30.72 92.16-76.8 107.52l-256 81.92-87.04 122.88h353.28c148.48 0 266.24-117.76 266.24-266.24V276.48c0-148.48-117.76-271.36-266.24-271.36zM276.48 814.08c-46.08-15.36-76.8-61.44-76.8-107.52V317.44c0-46.08 30.72-92.16 76.8-107.52l256-81.92L619.52 5.12H266.24C117.76 5.12 0 128 0 276.48v471.04c0 148.48 117.76 266.24 266.24 266.24h353.28l-87.04-122.88-256-76.8zM2493.44 250.88h-261.12v537.6h261.12V250.88z m-107.52 430.08h-56.32V353.28h56.32v327.68zM1848.32 988.16h102.4V138.24h107.52L1996.8 419.84v102.4h61.44v225.28c0 15.36-10.24 25.6-25.6 25.6h-25.6v102.4h51.2c56.32 0 102.4-46.08 102.4-102.4v-358.4H2099.2l61.44-281.6v-102.4h-312.32v957.44z"></path><path d="M2206.72 138.24H2560v660.48c0 46.08-35.84 87.04-87.04 87.04h-76.8v102.4h107.52c87.04 0 163.84-71.68 163.84-163.84V138.24h35.84v-102.4h-496.64v102.4zM3763.2 40.96h737.28v102.4H3763.2zM4541.44 527.36v-102.4H3727.36v102.4h204.8l-163.84 358.4v102.4h691.2c30.72 0 51.2-25.6 51.2-51.2 0-10.24 0-15.36-5.12-20.48l-87.04-194.56h-112.64l76.8 163.84h-496.64l163.84-358.4h491.52z"></path></svg></a><div class="e76910c82efe8556eb8a6ce6019c5d00_container"><button class="e76910c82efe8556eb8a6ce6019c5d00_controller" data-spm="dscroll-left"><i class="ee52067fb65534cb06d3b35f654f5441_icon f0a824eb82dac2d4dfef226ae9529970-button_left"></i></button><div class="e76910c82efe8556eb8a6ce6019c5d00_menu-warp"><nav class="_6bd4655fd97b17a7b684887be1d4e2a4_menus"><a class="_6bd4655fd97b17a7b684887be1d4e2a4_menu  " href="https://www.aliyun.com/product/tongyi" data-spm="d_menu_0">大模型</a><a class="_6bd4655fd97b17a7b684887be1d4e2a4_menu  " href="https://www.aliyun.com/product/list" data-spm="d_menu_1">产品</a><a class="_6bd4655fd97b17a7b684887be1d4e2a4_menu  " href="https://www.aliyun.com/solution/tech-solution/" data-spm="d_menu_2">解决方案</a><a class="_6bd4655fd97b17a7b684887be1d4e2a4_menu  " href="https://www.aliyun.com/resources" data-spm="d_menu_3">文档与社区</a><a class="_6bd4655fd97b17a7b684887be1d4e2a4_menu  " href="https://www.aliyun.com/benefit" data-spm="d_menu_4">权益中心</a><a class="_6bd4655fd97b17a7b684887be1d4e2a4_menu  " href="https://www.aliyun.com/price" data-spm="d_menu_5">定价</a><a class="_6bd4655fd97b17a7b684887be1d4e2a4_menu  " href="https://market.aliyun.com/" data-spm="d_menu_6">云市场</a><a class="_6bd4655fd97b17a7b684887be1d4e2a4_menu  " href="https://partner.aliyun.com/management/v2" data-spm="d_menu_7">合作伙伴</a><a class="_6bd4655fd97b17a7b684887be1d4e2a4_menu  " href="https://www.aliyun.com/service" data-spm="d_menu_8">支持与服务</a><a class="_6bd4655fd97b17a7b684887be1d4e2a4_menu  " href="https://www.aliyun.com/about" data-spm="d_menu_9">了解阿里云</a></nav></div><button class="e76910c82efe8556eb8a6ce6019c5d00_controller" data-spm="dscroll-right"><i class="ee52067fb65534cb06d3b35f654f5441_icon f0a824eb82dac2d4dfef226ae9529970-button_right"></i></button></div><div class="b62a767265ae40ce4e5e07aa2336b1be_search-wrap "><div class="global-nav-search _626567c051250ffe2f303af907d3fc83_global-nav-search"><div class="global-search-container _626567c051250ffe2f303af907d3fc83_global-nav-search-desktop-container"><div class="ff4f4a96a12f52ffbdd0d6adbdb6a2b0_position-desktop-search-container"><div><div class="f6fd7e4d3293f0634b9ac54848c275b7_default-search-panel  f6fd7e4d3293f0634b9ac54848c275b7_hidden-default-search-panel"></div><div class="_3b4f5487091623b0b6852e2b46d2729e_search-recommend-panel  _3b4f5487091623b0b6852e2b46d2729e_hidden-search-recommend-panel"><button class="_4b65cdd64479a2fabe582b8c0789821e_search-no-content " type="button"><div>查看 “</div><div class="_4b65cdd64479a2fabe582b8c0789821e_search-word"></div><div>” 全部搜索结果</div></button></div></div></div></div><div class="_626567c051250ffe2f303af907d3fc83_global-nav-search-mobile-container"><a class="_626567c051250ffe2f303af907d3fc83_search-button" href="https://www.aliyun.com/search?from=h5-global-nav-search"><span role="img" class="_9a1d73bbcd1a80626a31035a12410804_icon _626567c051250ffe2f303af907d3fc83_search-button-icon"><svg width="1em" height="1em" viewBox="0 0 32 32" focusable="false" color="currentColor" fill="currentColor" class="" data-icon="search"><g fill-rule="evenodd" stroke-width="1"><path d="M14,4 C15.3558127,4 16.653362,4.26210485 17.8926477,4.78631455 C19.0891275,5.29241739 20.1485621,6.00666269 21.0709515,6.92905045 C21.9933389,7.8514363 22.7075837,8.91087023 23.213686,10.1073523 C23.7378953,11.3466396 24,12.6441889 24,14 C24,15.3558159 23.737896,16.6533658 23.2136879,17.8926497 C22.838225,18.7802852 22.3482024,19.5924969 21.7436199,20.3292847 L27.7071819,26.2928467 L26.2929688,27.7070599 L20.3294201,21.7435112 C19.592603,22.3481382 18.7803456,22.8381971 17.8926477,23.2136879 C16.6533607,23.737896 15.3558114,24 14,24 C12.6441879,24 11.3466384,23.737896 10.1073513,23.2136879 C8.91087246,22.7075844 7.85143844,21.9933383 6.92904925,21.0709496 C6.00666173,20.1485621 5.29241653,19.0891282 4.78631365,17.8926477 C4.26210455,16.6533613 4,15.3558121 4,14 C4,12.6441879 4.26210451,11.3466388 4.78631353,10.1073527 C5.29241594,8.91087262 6.00666118,7.85143844 6.92904925,6.92905021 C7.85143812,6.00666118 8.91087198,5.2924157 10.1073508,4.78631377 C11.3466366,4.26210459 12.6441863,4 14,4 Z M14,6 C11.7910172,6 9.90543811,6.78108788 8.34326267,8.34326363 C6.78108756,9.90543874 6,11.7910175 6,14 C6,16.2089825 6.78108756,18.0945616 8.34326267,19.6567373 C9.90543779,21.2189124 11.7910169,22 14,22 C16.2089844,22 18.0945635,21.2189128 19.6567373,19.6567383 C21.2189124,18.0945644 22,16.208985 22,14 C22,11.7910175 21.2189124,9.9054389 19.6567373,8.3432641 C18.0945622,6.78108803 16.2089831,6 14,6 Z"></path></g></svg></span></a></div></div></div><div class="_687dcfd9dc95efb27374014acbe88037_container"><button class="_687dcfd9dc95efb27374014acbe88037_item"><i class="ee52067fb65534cb06d3b35f654f5441_icon f0a824eb82dac2d4dfef226ae9529970-intl"></i></button><button class="_687dcfd9dc95efb27374014acbe88037_item"><i class="ee52067fb65534cb06d3b35f654f5441_icon f0a824eb82dac2d4dfef226ae9529970-contact _2b88897e79e906382c0bd9ee52b33c40_icon"></i></button><a class="_687dcfd9dc95efb27374014acbe88037_item _2d3ef330b3f8055912d355b9a255bfcf_btn global-nav-ai-assistant" href="https://www.aliyun.com/ai-assistant?displayMode=side" data-spm="dai_assistant" target="_blank"><div class="LogoStyled-aliyun-ai-assistant-rc-8096__sc-1qusfpt-0 cpJKij"><div class="ai-assistant-brand-logo-icon" style="background:no-repeat center/100%  url(https://img.alicdn.com/imgextra/i4/O1CN012X1Rxl1clAgB5waMK_!!6000000003640-2-tps-52-52.png)"><img src="https://img.alicdn.com/imgextra/i2/O1CN01bYc1m81RrcSAyOjMu_!!6000000002165-54-tps-60-60.apng" loading="lazy"/></div><div class="ai-assistant-brand-logo-tooltip "><div class="ai-assistant-logo-tooltip-content">AI 助理</div></div></div></a><a class="_687dcfd9dc95efb27374014acbe88037_item" href="https://beian.aliyun.com/" target="_blank" data-spm="d_beian">备案</a><a class="_687dcfd9dc95efb27374014acbe88037_item" href="https://home.console.aliyun.com/home/dashboard/ProductAndService" target="_blank" rel="nofollow" data-spm="d_console">控制台</a><span class="a0203b3108302f476b0541e6fc593008_loading"></span></div></header></div><div class="c97dc5fe8c8f69b0e60edf6a1f709489_mobile de5ef2fee09ebcb2b1dcaf0c982523bc_theme bdac01e7d42089a1161e0315c2a68512_reset"></div><div class="_18a32969382a277c44015217fbc5cb5a_box"></div></div></div></header>

  <div id="app"><div class="MainLayout--mainContainer--FzmzeDI" id="docs-container"><div class="MainLayout--helpBodyHead--fFcCOhC"><div class="HelpBodyHead--helpBodyHeadBox--VWOHGv0 help-body-head" data-spm="help-sub-nav"><div class="HelpBodyHead--helpBodyHead--YgG0_RH help-body-head-content"><div class="HelpBodyHead--helpHeadDocName--eZC8orQ"><a href="/" data-spm="d_logo">官方文档</a></div><div class="help-tablist"></div><div class="HelpBodyHead--bodyHeadRight--mgSoj67"><div class="HelpBodyHead--helpBodyBoxHeaderSearch--O8sAtVd"><div class="TopSearch--helpTopSearch--cLwlKgP help-search" data-spm="d_help_search"><div class="TopSearch--helpTopSearchBtn--xhPPdCV help-search-btn"><span>输入文档关键字查找</span><i class="TopSearch--searchIcon--X4SD3b9 help-iconfont help-icon-sousuoicon"></i></div></div></div></div></div><div class="HelpBodyHead--productList--YJ9ism5" style="display:none"><div class="ProductList--allProducts--Z87vhzs"><div class="ProductList--allProductsHead--l2aMmm6"><div class="ProductList--allProductsSearchWrapper--PgTrGTl"><div class="ProductList--allProductsSearch--edTNjmr"><span role="img" class="Icon--icon--jErARdR ProductList--searchIcon--NrFYKki"><svg width="1em" height="1em" viewBox="0 0 32 32" focusable="false" color="currentColor" fill="currentColor" class="" data-icon="document-search"><g fill-rule="evenodd" stroke-width="1"><path d="M19,3 L27,11 L27,29 L5,29 L5,3 L19,3 Z M18,5 L7,5 L7,27 L25,27 L25,12 L18,12 L18,5 Z M20,6.82842636 L20,10 L23.1715736,10 L20,6.82842636 Z"></path><path d="M15.5,13.5 C16.8806419,13.5 18.0591358,13.9881726 19.0354815,14.9645178 C20.0118272,15.9408637 20.5,17.1193577 20.5,18.5 C20.5,19.5346034 20.2258676,20.4556918 19.6776028,21.2632651 L22.1636839,23.7493687 L20.749464,25.1635761 L18.2634125,22.6775026 C17.4558048,23.2258342 16.5346673,23.5 15.5,23.5 C14.1193581,23.5 12.9408642,23.0118272 11.9645183,22.0354815 C10.9881728,21.0591364 10.5,19.8806426 10.5,18.5 C10.5,17.1193576 10.9881728,15.9408636 11.9645183,14.9645181 C12.9408638,13.9881727 14.1193577,13.5 15.5,13.5 Z M15.5,15.5 C14.6716423,15.5 13.9645529,15.7929106 13.3787317,16.3787317 C12.7929106,16.9645527 12.5,17.6716421 12.5,18.5 C12.5,19.3283571 12.7929105,20.0354462 13.3787315,20.6212673 C13.964553,21.2070891 14.6716425,21.5 15.5,21.5 C16.3283577,21.5 17.0354471,21.2070891 17.6212683,20.6212673 C18.2070894,20.0354462 18.5,19.3283571 18.5,18.5 C18.5,17.6716421 18.2070894,16.9645526 17.6212683,16.3787315 C17.0354471,15.7929105 16.3283577,15.5 15.5,15.5 Z"></path></g></svg></span><input placeholder="输入文档关键字查找"></div></div></div><div class="ProductList--allProductsBody--jNYsZlh"></div></div></div></div></div><div class="PcLayout--docsContainer--pwbB9bE"><div class="PcLayout--mobileHelpBodyHead--g_YCRMg"><div class="HelpBodyHead--mobileHeadBlank--_hX8BWJ"></div></div><div class="PcLayout--aliyunAppLayout--_QE36ni"><nav class="aliyun-docs-menu" id="aliyun-docs-menu"><div class="Menu--helpMenuBox--WZ7MX3B" id="help-menu-box" style="width:300px"><div class="Menu--helpMenuInnerBox--kxSXymh aliyun-docs-toc-content" style="width:300px"><div class="Menu--helpMenuDrag--fs9WrRe help-menu-drag-box"></div><div class="Menu--helpMenu--reWzeMt"><div class="help-menu-subproduct"></div><div class="MenuSearch--collapseActionBar--m98Zp_n"><div class="MenuSearch--searchContainer--yxqXL6w"><div class="MenuSearch--searchInputWrapper--xJnk941"><span role="img" class="Icon--icon--jErARdR MenuSearch--searchIcon--YWpGKq9"><svg width="1em" height="1em" viewBox="0 0 32 32" focusable="false" color="currentColor" fill="currentColor" class="" data-icon="document-search"><g fill-rule="evenodd" stroke-width="1"><path d="M19,3 L27,11 L27,29 L5,29 L5,3 L19,3 Z M18,5 L7,5 L7,27 L25,27 L25,12 L18,12 L18,5 Z M20,6.82842636 L20,10 L23.1715736,10 L20,6.82842636 Z"></path><path d="M15.5,13.5 C16.8806419,13.5 18.0591358,13.9881726 19.0354815,14.9645178 C20.0118272,15.9408637 20.5,17.1193577 20.5,18.5 C20.5,19.5346034 20.2258676,20.4556918 19.6776028,21.2632651 L22.1636839,23.7493687 L20.749464,25.1635761 L18.2634125,22.6775026 C17.4558048,23.2258342 16.5346673,23.5 15.5,23.5 C14.1193581,23.5 12.9408642,23.0118272 11.9645183,22.0354815 C10.9881728,21.0591364 10.5,19.8806426 10.5,18.5 C10.5,17.1193576 10.9881728,15.9408636 11.9645183,14.9645181 C12.9408638,13.9881727 14.1193577,13.5 15.5,13.5 Z M15.5,15.5 C14.6716423,15.5 13.9645529,15.7929106 13.3787317,16.3787317 C12.7929106,16.9645527 12.5,17.6716421 12.5,18.5 C12.5,19.3283571 12.7929105,20.0354462 13.3787315,20.6212673 C13.964553,21.2070891 14.6716425,21.5 15.5,21.5 C16.3283577,21.5 17.0354471,21.2070891 17.6212683,20.6212673 C18.2070894,20.0354462 18.5,19.3283571 18.5,18.5 C18.5,17.6716421 18.2070894,16.9645526 17.6212683,16.3787315 C17.0354471,15.7929105 16.3283577,15.5 15.5,15.5 Z"></path></g></svg></span><input placeholder="在目录中筛选" class="MenuSearch--searchInput--vYXA7NN"></div></div></div><div class="help-menu-scroll-container Menu--menuContent--f6GC88t" data-spm="help-menu-undefined"><ul id="common-menu-container">
 <li id="2400262" class="Menu--level1--UN3zYr3">
<a href="/zh/model-studio/model-user-guide/">
<i class="iconfont icon-close-arrow"></i>
<span class="Menu--menuItemText--a6B4ZGH">用户指南（模型）</span>
</a>
</li>
 <li id="2840916" class="Menu--level1--UN3zYr3">
<a href="/zh/model-studio/application-user-guide/">
<i class="iconfont icon-close-arrow"></i>
<span class="Menu--menuItemText--a6B4ZGH">用户指南（应用）</span>
</a>
</li>
 <li id="2400264" class="Menu--level1--UN3zYr3">
<a href="/zh/model-studio/model-api-reference/">
<i class="iconfont icon-close-arrow"></i>
<span class="Menu--menuItemText--a6B4ZGH">API参考（模型）</span>
</a>
</li>
 <li id="2863247" class="Menu--level1--UN3zYr3">
<a href="/zh/model-studio/applicantion-api-reference/">
<i class="iconfont icon-close-arrow"></i>
<span class="Menu--menuItemText--a6B4ZGH">API参考（应用）</span>
</a>
</li>
 <li id="2987628" class="Menu--level1--UN3zYr3">
<a href="/zh/model-studio/product-dynamics/">
<i class="iconfont icon-close-arrow"></i>
<span class="Menu--menuItemText--a6B4ZGH">产品动态</span>
</a>
</li>
</ul></div></div></div></div></nav><main class="aliyun-docs-view" id="aliyun-docs-view"><div class="ProductDetail--contentWrapper--iCunrBZ"><section class="aliyun-docs-content" style="height:auto"><header class="aliyun-docs-view-header"><div class="Header--topBar--LXfTLL5"><div class="BreadCrumb--breadcrumb--s_Uzlex"><div class="BreadCrumb--breadcrumb--cbt4qaF">
<a href="/">首页</a>
 <span class="BreadCrumb--arrow--FD7AzzB">
<i class="iconfont icon-right-arrow"></i>
</span>
 <a href="/zh/model-studio/">大模型服务平台百炼</a>
 <span class="BreadCrumb--arrow--FD7AzzB">
<i class="iconfont icon-right-arrow"></i>
</span>
 <a href="/zh/model-studio/model-user-guide/">用户指南（模型）</a>
 <span class="BreadCrumb--arrow--FD7AzzB">
<i class="iconfont icon-right-arrow"></i>
</span>
 <a href="/zh/model-studio/use-cases/">实践教程</a>
 <span class="BreadCrumb--arrow--FD7AzzB">
<i class="iconfont icon-right-arrow"></i>
</span>
 <span>用Assistant API构建Multi-Agent</span>
</div></div></div><div class="Header--title--iTk2tUo"><h1>借助 Assistant API 构建具备自动规划能力的 Multi Agent 系统</h1><div class="Header--actionBar--dvzFYrk"><div class="Header--left--x8TGxDL"><span class="Header--updateTime--YXGPhcZ">更新时间：</span></div><div class="Header--right--l4TSW1E"><div class="Header--linkButton--LpCRs1O"><div class="OuterUrl--outUrl--ZFzJIhk"><a href="https://www.aliyun.com/product/bailian" target="_blank" rel="noreferrer">产品详情</a></div></div><div class="Contact--contactButton--TBwTX5R"><span class="Contact--favoritesBtn--J8mRVBp" title="收藏本文档" data-spm-click="gostr=/aliyun;locaid=collect"><i class="help-iconfont help-icon-like"></i></span><a href="/my_favorites.html">我的收藏</a></div></div></div></div></header><div class="pc-markdown-container unionContainer" id="pc-markdown-container"><div class="markdown-body"><div lang="zh" class="icms-help-docs-content">
<main id="main-2725769"><p id="96d23029aajre" data-tag="shortdesc" class="shortdesc">本文将通过构建一个查询阿里云资源信息的<span class="help-letter-space"></span>Multi Agent<span class="help-letter-space"></span>系统，帮助您了解如何通过阿里云百炼平台的<span class="help-letter-space"></span>Assistant API<span class="help-letter-space"></span>构建一个无需提前定义、可自动规划编排任务流程的<span class="help-letter-space"></span>Multi Agent<span class="help-letter-space"></span>系统。</p><div data-tag="body" class="body"><p id="865e8c1b81ssb">多智能体系统（Multi Agent System）是多个<span class="help-letter-space"></span>Agent<span class="help-letter-space"></span>协作完成任务的方式，在多数场景下，比单<span class="help-letter-space"></span>Agent<span class="help-letter-space"></span>完成任务准确率更高。通过给每个<span class="help-letter-space"></span>Agent<span class="help-letter-space"></span>制定明确且专业的角色名称和职责描述，不仅可以提升它们的专业性，还能帮助它们更好地理解和配合各自的工作。Multi Agent System<span class="help-letter-space"></span>的设计十分灵活，您可以参考本案例中的设计和示例代码，将其应用到您的业务中。</p><section id="17108a6a7cz9d" class="section"><h2 id="e0a5b2295fz8p"><b>效果展示</b></h2><p id="0b32e2662etyg">通过本文提供的教程，您可以实现一个能进行阿里云资源信息查询的 Multi Agent 系统。该系统在收到用户问题后，会自动规划多个 Agent 之间的协作流程，按照规划执行任务后给出最终答案。</p><table bordertype="no-border" id="9821cf98c10s5" tablewidth="100" tablecolswidth="47.54 52.46" autofit="true" class="table"><colgroup colwidth="0.95*" style="width:47.54%"></colgroup><colgroup colwidth="1.05*" style="width:52.46%"></colgroup><tbody class="tbody"><tr id="6dab2954439mb" style="height:33px"><td id="35fba2ff59b6q" rowspan="1" style="vertical-align:top" colspan="1"><p id="80678db71dz7o"><img id="b509cb2154yke" src="https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/9873322271/p826565.png" alt="image" placement="break" class="image break"></p></td><td id="7bd3b4b7c9vdq" rowspan="1" style="vertical-align:top" colspan="1"><p id="644d609bdf2ox"><img id="ca84dee9821xl" src="https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/9873322271/p826567.gif" alt="output" placement="break" class="image break"></p></td></tr></tbody></table><p id="d82d6e4de3c69"><b>详细工作流程：</b></p><ol id="e47d9beef4q5l"><li id="6cdebdf9eajz3"><p id="513d2bdb8clqs">用户进行提问；</p></li><li id="f818e498a6lhe"><p id="8e315853b8u38">PlannerAssistant<span class="help-letter-space"></span>接收到用户的提问，并根据用户问题对其它<span class="help-letter-space"></span>Agent<span class="help-letter-space"></span>进行选择并编排其运行顺序；</p></li><li id="39eb2224894tu"><p id="7caf5f9d0fauu">ChatAssistant、AliyunInfoAssistant<span class="help-letter-space"></span>与<span class="help-letter-space"></span>InstanceTypeDetailAssistant<span class="help-letter-space"></span>分别有对应的职责与能力，它们是本教程<span class="help-letter-space"></span>Multi Agent<span class="help-letter-space"></span>系统中被<span class="help-letter-space"></span>PlannerAssistant<span class="help-letter-space"></span>编排的<span class="help-letter-space"></span>Agent。编排完成后的<span class="help-letter-space"></span>Agent<span class="help-letter-space"></span>组合会接收用户的提问，并按照程序中设计的<span class="help-letter-space"></span>Multi Agent<span class="help-letter-space"></span>交互逻辑进行分工合作；</p></li><li id="2fa5343ca3yke"><p id="c834e9fe50o4l">SummaryAssistant<span class="help-letter-space"></span>将各<span class="help-letter-space"></span>Agent<span class="help-letter-space"></span>的输出信息汇总，并结合用户问题对信息进行总结，其输出会作为<span class="help-letter-space"></span>Multi Agent<span class="help-letter-space"></span>系统的最终输出。</p></li></ol></section><section id="8de022a754rpk" class="section"><h2 id="01971ae2417uk"><b>前提条件</b></h2><ol id="228dd09b0en4z"><li id="7fed9ae1f9603"><p id="dcd8ab5d81n18">请参考<a href="https://help.aliyun.com/zh/ram/user-guide/create-an-accesskey-pair" id="5e2b0caca896i" title="" class="xref">创建<span class="help-letter-space"></span>AccessKey</a>，获取用户的<code data-tag="code" code-type="xCode" id="72c3a28393eu7" class="code">ACCESS_KEY_ID</code>和<code data-tag="code" code-type="xCode" id="af92bd7492j1j" class="code">ACCESS_KEY_SECRET</code>。</p></li><li id="247b9ef8d7m57"><p id="97b1e8426c26g">请开通阿里云百炼服务并<a href="https://help.aliyun.com/zh/model-studio/get-api-key" id="270b3e35605qq" title="" class="xref">获取与配置 API Key</a>。</p></li><li id="378166f9fcpog"><p id="db8adfe8e8jcv">我们推荐您将<code data-tag="code" code-type="xCode" id="061c7e1c75ssz" class="code">ALIBABA_CLOUD_ACCESS_KEY_ID</code>、<code data-tag="code" code-type="xCode" id="8a436ba0c9z3b" class="code">ALIBABA_CLOUD_ACCESS_KEY_SECRET</code>和<code data-tag="code" code-type="xCode" id="b716074fcd21c" class="code">DASHSCOPE_API_KEY</code>配置在环境变量中，以降低泄露风险。环境变量配置方法可参考：<a href="https://help.aliyun.com/zh/model-studio/configure-api-key-through-environment-variables" id="9b3f41e31fenk" title="" class="xref">配置<span class="help-letter-space"></span>API Key<span class="help-letter-space"></span>到环境变量</a>。在本教程中，您可以参考以下命令，根据您的操作系统选择配置环境变量的方法：</p><div outputclass="tabbed-codeblock" data-tag="fig" id="a71542f4f1uie" class="tabbed-codeblock-box"><div class="tab-box"></div><input type="radio" name="check-a71542f4f1uie" id="a71542f4f1uie-bash-tab" checked=""><label for="a71542f4f1uie-bash-tab">Bash</label><div class="codeblock-item"><pre code-type="xCode" id="0964de0b50nlb" data-tag="codeblock" outputclass="language-bash" class="pre codeblock language-bash"><code># 用您的<span class="help-letter-space"></span>API-KEY<span class="help-letter-space"></span>与阿里云<span class="help-letter-space"></span>AK<span class="help-letter-space"></span>信息进行替换
export DASHSCOPE_API_KEY="YOUR_DASHSCOPE_API_KEY"
export ALIBABA_CLOUD_ACCESS_KEY_ID="YOUR_ALIBABA_CLOUD_ACCESS_KEY_ID"
export ALIBABA_CLOUD_ACCESS_KEY_SECRET="YOUR_ALIBABA_CLOUD_ACCESS_KEY_SECRET"</code></pre></div><input type="radio" name="check-a71542f4f1uie" id="a71542f4f1uie-powershell-tab"><label for="a71542f4f1uie-powershell-tab">PowerShell</label><div class="codeblock-item"><pre code-type="xCode" id="a0e22394adu3c" data-tag="codeblock" outputclass="language-powershell" class="pre codeblock language-powershell"><code># 用您的<span class="help-letter-space"></span>API-KEY<span class="help-letter-space"></span>与阿里云<span class="help-letter-space"></span>AK<span class="help-letter-space"></span>信息进行替换
$env:DASHSCOPE_API_KEY = "YOUR_DASHSCOPE_API_KEY"
$env:ALIBABA_CLOUD_ACCESS_KEY_ID="YOUR_ALIBABA_CLOUD_ACCESS_KEY_ID"
$env:ALIBABA_CLOUD_ACCESS_KEY_SECRET="YOUR_ALIBABA_CLOUD_ACCESS_KEY_SECRET"</code></pre></div></div></li><li id="47b2012cebju9"><p id="1d5674b8507mv">如果您没有创建<span class="help-letter-space"></span>ECS<span class="help-letter-space"></span>实例，请前往<span class="help-letter-space"></span><a class="" href="https://ecs.console.aliyun.com" id="304b888646kor">ECS<span class="help-letter-space"></span>控制台</a>创建一个按量付费的实例。</p><div type="note" id="fd34fe1f32pq3" class="note note-note"><div class="note-icon-wrapper"><i class="icon-note note note"></i></div><div class="noteContentSpan"><strong>说明 </strong><p id="31a90b507b0cq">如果您在完成本实践教程后没有继续使用<span class="help-letter-space"></span>ECS<span class="help-letter-space"></span>实例的需求，请及时释放您的<span class="help-letter-space"></span>ECS<span class="help-letter-space"></span>资源，避免产生不必要的消费。</p></div></div></li><li id="6a30974fd3b52"><p id="940c6dfcc4y6j">请确认您的计算环境中已安装<span class="help-letter-space"></span>Python。您可以新建一个<code data-tag="code" code-type="xCode" id="5987d69cbahrs" class="code">requirements.txt</code>文件，将以下内容复制到<span class="help-letter-space"></span>txt<span class="help-letter-space"></span>文件中。</p><pre code-type="xCode" id="b78881e94dkkg" data-tag="codeblock" outputclass="language-plaintext" class="pre codeblock language-plaintext"><code>alibabacloud_tea_openapi
alibabacloud_tea_util
alibabacloud_openapi_util
alibabacloud_ecs20140526
alibabacloud_bssopenapi20171214
dashscope
gradio</code></pre><p id="fc9c1bc7c50jo">在您保存<code data-tag="code" code-type="xCode" id="1701bac42bs4g" class="code">requirements.txt</code>文件后，请您在<code data-tag="code" code-type="xCode" id="dce97fe1b5f17" class="code">requirements.txt</code>所在目录中运行以下命令安装依赖：</p><pre code-type="xCode" id="faac93981997g" data-tag="codeblock" outputclass="language-bash" class="pre codeblock language-bash"><code>pip install -r requirements.txt</code></pre></li><li id="d6285015f3whx"><p id="9f841fb8abp6p">请您参考<span class="help-letter-space"></span><a href="https://help.aliyun.com/zh/model-studio/build-knowledge-base-qa-assistant-without-coding/" id="8ed7b5893570t" title="" class="xref">0<span class="help-letter-space"></span>代码构建问答应用</a>文档，在阿里云百炼平台创建<span class="help-letter-space"></span>RAG<span class="help-letter-space"></span>应用，知识库文件选择<span class="help-letter-space"></span>PDF<span class="help-letter-space"></span>格式的阿里云<span class="help-letter-space"></span>ECS<span class="help-letter-space"></span>官方文档<a class="file" href="https://help-static-aliyun-doc.aliyuncs.com/file-manage-files/zh-CN/20240701/dnazer/%E5%AE%9E%E4%BE%8B%E8%A7%84%E6%A0%BC%E6%97%8F.pdf" id="11bff869f0259">实例规格族.pdf</a>，并获取其应用<span class="help-letter-space"></span>ID。</p><p id="eb101a789az8h"><img id="ca72c5eabf23g" src="https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/8977177471/p957657.png" alt="image" placement="break" props="china" width="450" height="193.088" data-cond-props="china" class="image break"></p><p id="10f2a65ef4o8r"></p></li></ol></section><section id="afc21a1265tnb" class="section"><h2 id="fabe2556eavti"><b>代码实现</b></h2><p id="5424955895rp5">您需要准备两个<span class="help-letter-space"></span>py<span class="help-letter-space"></span>文件，分别为<code data-tag="code" code-type="xCode" id="2d8ca42e4579e" class="code">tools.py</code>与<code data-tag="code" code-type="xCode" id="1ddb6419eeooi" class="code">main.py</code>，这两个文件需要放置在同一目录中。</p><section id="01b82195e6ob5" class="section"><h3 id="74d240e4f1llz"><b>工程文件</b></h3><p id="31ccd092c4dih">请下载<span class="help-letter-space"></span><a class="file" href="https://help-static-aliyun-doc.aliyuncs.com/file-manage-files/zh-CN/20250811/zqkfgg/multi_agent.zip" id="954bafecbav0r">multi_agent.zip</a><span class="help-letter-space"></span>到本地后进行解压。</p></section><section id="23d90557e8omq" class="section"><h3 id="00ba95b176dzh"><b>tools.py（用于定义工具函数）</b></h3><p id="5e3e9089277l9"><code data-tag="code" code-type="xCode" id="63acc14c4cp0m" class="code">tools.py</code>主要定义了<span class="help-letter-space"></span>Agent<span class="help-letter-space"></span>会使用到的工具函数。<code data-tag="code" code-type="xCode" id="43a9197c981hu" class="code">tools.py</code>整体代码可见<span class="help-letter-space"></span><a href="#1665f852562ik" id="2433f28f6bn0w" title="" class="xref">tools.py<span class="help-letter-space"></span>整体代码</a>。</p><h4 id="32689d5042z7u"><b>引入依赖</b></h4><pre code-type="xCode" id="5d092b11893dh" data-tag="codeblock" outputclass="language-python" props="china" data-cond-props="china" class="pre codeblock language-python"><code>from alibabacloud_tea_util import models as util_models
from alibabacloud_ecs20140526.client import Client as Ecs20140526Client
from alibabacloud_ecs20140526 import models as ecs_20140526_models
from alibabacloud_tea_openapi import models as open_api_models
from alibabacloud_bssopenapi20171214.client import Client as BssOpenApi20171214Client
from dashscope import Application
import os</code></pre><h4 id="bc610d6be88x5"><b>定义工具</b></h4><p id="631ad6373cxom"><code data-tag="code" code-type="xCode" id="6ba2e69eaczki" class="code">tools.py</code>中主要使用到了两个工具类，分别为<span class="help-letter-space"></span>ECS<span class="help-letter-space"></span>与<span class="help-letter-space"></span>Billing。ECS<span class="help-letter-space"></span>的类方法包含有<code data-tag="code" code-type="xCode" id="a52003957579z" class="code">query_source</code>和<code data-tag="code" code-type="xCode" id="19e5f338ff0ot" class="code">call_agent_app</code>，Billing<span class="help-letter-space"></span>的类方法包含<code data-tag="code" code-type="xCode" id="1e5a408a67wsl" class="code">get_balance</code>。您可以参考以下代码，添加您需要的工具类与工具函数以适配您的业务。</p><section outputclass="tabbed-content-box" id="a378da0f7506t" data-tag="tabbed-content-box" class="tabbed-content-box section"><section id="138601279083v" class="section"><h5 id="a5e271f90bjs5"><b>ECS</b></h5><p id="20ba8a6a53zw2">ECS<span class="help-letter-space"></span>有两个类函数：<code data-tag="code" code-type="xCode" id="f75b3f4c3afz0" class="code">query_source</code>与<code data-tag="code" code-type="xCode" id="396724a5efk72" class="code">call_agent_app</code>。</p><p id="8937e05fa735p"><code data-tag="code" code-type="xCode" id="49cffa75a4x9q" class="code">query_source</code>通过阿里云的<span class="help-letter-space"></span>OpenAPI<span class="help-letter-space"></span>服务查询指定区域的<span class="help-letter-space"></span>ECS<span class="help-letter-space"></span>实例信息。函数输入为<span class="help-letter-space"></span>RegionID，如<code data-tag="code" code-type="xCode" id="b37bd32626yz4" class="code">cn-hangzhou</code>、<code data-tag="code" code-type="xCode" id="4c10724fe8hfl" class="code">cn-beijing</code>、<code data-tag="code" code-type="xCode" id="7a21195557rd4" class="code">cn-shanghai</code>、<code data-tag="code" code-type="xCode" id="e0d9aa3794ugb" class="code">ap-southeast-1</code>等；输出包含实例<span class="help-letter-space"></span>ID、实例规格与价格信息。</p><p id="49e77bfde8yj1"><code data-tag="code" code-type="xCode" id="c08076b0799jv" class="code">call_agent_app</code>函数通过集成阿里云<span class="help-letter-space"></span>ECS<span class="help-letter-space"></span>官方文档<a class="file" href="https://help-static-aliyun-doc.aliyuncs.com/file-manage-files/zh-CN/20240701/dnazer/%E5%AE%9E%E4%BE%8B%E8%A7%84%E6%A0%BC%E6%97%8F.pdf" id="763855c4b4cf5">实例规格族.pdf</a><span class="help-letter-space"></span>知识库的阿里云百炼<span class="help-letter-space"></span>RAG<span class="help-letter-space"></span>应用查询实例规格的详细信息，包括<span class="help-letter-space"></span>vCPU<span class="help-letter-space"></span>个数、内存大小等指标数据。您需要获取您在阿里云百炼创建应用的<code data-tag="code" code-type="xCode" id="769b7f912920r" class="code">app_id</code>并在代码中的对应位置进行替换。函数输入参数为<span class="help-letter-space"></span>ECS<span class="help-letter-space"></span>实例规格列表，如<code data-tag="code" code-type="xCode" id="a2c2220e0f0k1" class="code">['ecs.e-c1m1.large', 'ecs.u1-c1m4.xlarge']</code>，输出为<span class="help-letter-space"></span>RAG<span class="help-letter-space"></span>应用的回复。需要注意的是，与<span class="help-letter-space"></span>Agent<span class="help-letter-space"></span>相似，RAG<span class="help-letter-space"></span>应用的背后也是基于大模型驱动，因此<code data-tag="code" code-type="xCode" id="3e00696dee5l0" class="code">call_agent_app</code>的运行时间可能较长。</p><p id="777402b04fbf3"><b>ECS<span class="help-letter-space"></span>类</b>的定义代码如下：</p><div id="ce72da3e77lmp" type="note" class="note note-note"><div class="note-icon-wrapper"><i class="icon-note note note"></i></div><div class="noteContentSpan"><strong>说明 </strong><p id="468a6905bezo7">请用您在阿里云百炼平台创建的<span class="help-letter-space"></span>RAG<span class="help-letter-space"></span>应用的<code data-tag="code" code-type="xCode" id="666ce0c7c2onl" class="code">app_id</code>替代代码中的<code data-tag="code" code-type="xCode" id="c15eb80a353xt" class="code">app_id</code>。</p></div></div><pre code-type="xCode" id="063bdc69a4jgy" data-tag="codeblock" outputclass="language-python" props="china" data-cond-props="china" class="pre codeblock language-python"><code>class ECS:
    @classmethod
    # 输入：地域ID，如cn-hangzhou，cn-beijing等
    # 输出：查询ecs实例规格信息，包括实例ID，实例规格，每小时收费。（系统盘默认按照cloud_auto，40GiB）
    def query_source(cls,RegionID):
        config = open_api_models.Config(
                # 从环境变量中获取阿里云的AK信息
                access_key_id=os.getenv("ALIBABA_CLOUD_ACCESS_KEY_ID"),
                access_key_secret=os.getenv("ALIBABA_CLOUD_ACCESS_KEY_SECRET")
            )
        # 杭州与北京、上海等地区的endpoint不同，此处进行判断
        if RegionID != 'cn-hangzhou':
            config.endpoint = f'ecs.{RegionID}.aliyuncs.com'
        else:
            config.endpoint = f'ecs-{RegionID}.aliyuncs.com'
        client = Ecs20140526Client(config)
        describe_instances_request = ecs_20140526_models.DescribeInstancesRequest(region_id=RegionID)
        runtime = util_models.RuntimeOptions()
        # 获得ECS实例信息
        response_source = client.describe_instances_with_options(describe_instances_request, runtime).body
        if len(response_source.instances.instance) == 0:
            return "您在当前区域无ecs实例"
        # 初始化要返回的结果
        result = ""
        # 可能有多个实例，因此用for循环遍历所有实例
        for i in range(len(response_source.instances.instance)):
            # 系统盘类型与存储空间，此处默认设为cloud_auto，40GiB
            system_disk = ecs_20140526_models.DescribePriceRequestSystemDisk(
                category='cloud_auto',
                size=40
            )
            describe_price_request = ecs_20140526_models.DescribePriceRequest(
                region_id=RegionID,
                resource_type='instance',
                instance_type=response_source.instances.instance[i].instance_type,
                system_disk=system_disk
            )
            response = client.describe_price_with_options(describe_price_request, runtime).body
            cur_result = f"""实例：{response_source.instances.instance[i].instance_id} 的规格为：{response_source.instances.instance[i].instance_type}，
    每个小时的收费为{response.price_info.price.trade_price}元\n"""
            # 将当前实例的信息添加到返回结果中
            result += cur_result
        return result
    @classmethod
    # RAG应用调用
    def call_agent_app(cls,InstanceType):
        if len(InstanceType) == 0:
            return "您在当前区域无ecs实例"
        result = ""
        for i in range(len(InstanceType)):
            response = Application.call(
                # 此处填写RAG应用的app_id
                app_id='xxx',
                prompt=f'介绍一下{InstanceType[i]}',
                # 从环境变量中获取Dashscope的API Key
                api_key=os.getenv("DASHSCOPE_API_KEY"))
            result += response.output.text
        return result</code></pre></section><section id="2e2655d556c6h" class="section"><h5 id="9d4b302b0ejxo"><b>Billing</b></h5><p id="00691ecabdl2q">Billing<span class="help-letter-space"></span>类中有一个函数<code data-tag="code" code-type="xCode" id="6c310c6296x3p" class="code">get_balance</code>。</p><p id="39eb608bfbgz6"><code data-tag="code" code-type="xCode" id="9e2d04c0c4w01" class="code">get_balance</code>通过阿里云的<span class="help-letter-space"></span>OpenAPI<span class="help-letter-space"></span>服务查询阿里云的余额信息。</p><pre id="3de4ea431bu42" outputclass="language-python" data-tag="codeblock" code-type="xCode" class="pre codeblock language-python"><code>class Billing:
    # 无需输入，返回为阿里云账户余额信息
    @classmethod
    def get_balance(cls):
        # 创建客户端
        config = open_api_models.Config(
            # 必填，请确保代码运行环境设置了环境变量 ALIBABA_CLOUD_ACCESS_KEY_ID。,
            access_key_id=os.environ['ALIBABA_CLOUD_ACCESS_KEY_ID'],
            # 必填，请确保代码运行环境设置了环境变量 ALIBABA_CLOUD_ACCESS_KEY_SECRET。,
            access_key_secret=os.environ['ALIBABA_CLOUD_ACCESS_KEY_SECRET']
        )
        # Endpoint 请参考 https://api.aliyun.com/product/BssOpenApi
        config.endpoint = f'business.aliyuncs.com'
        runtime = util_models.RuntimeOptions()
        client = BssOpenApi20171214Client(config)
        balance_info = client.query_account_balance_with_options(runtime).body.data
        return f"""币种为：{balance_info.currency}，可用额度为{balance_info.available_amount}，信控余额为{balance_info.credit_amount}，
        网商余额为{balance_info.mybank_credit_amount}，现金余额为{balance_info.available_cash_amount}，生态客户Quota限额为{balance_info.quota_limit}。"""</code></pre></section></section><h4 id="1665f852562ik"><code data-tag="code" code-type="xCode" id="bb9ab0a95bvsn" class="code"><b>tools.py</b></code><b>整体代码</b></h4><p id="4f19bd4245qdm"><code data-tag="code" code-type="xCode" id="6432f38177070" class="code">tools.py</code>整体代码如下：</p><pre id="8b6df9d9181fw" outputclass="language-python" data-tag="codeblock" code-type="xCode" props="china" data-cond-props="china" class="pre codeblock language-python"><code>from alibabacloud_tea_util import models as util_models
from alibabacloud_ecs20140526.client import Client as Ecs20140526Client
from alibabacloud_ecs20140526 import models as ecs_20140526_models
from alibabacloud_tea_openapi import models as open_api_models
from alibabacloud_bssopenapi20171214.client import Client as BssOpenApi20171214Client
from dashscope import Application
import os

class ECS:
    @classmethod
    # 输入：地域ID，如cn-hangzhou，cn-beijing等
    # 输出：查询ecs实例规格信息，包括实例ID，实例规格，每小时收费。（系统盘默认按照cloud_auto，40GiB）
    def query_source(cls,RegionID):
        config = open_api_models.Config(
                # 从环境变量中获取阿里云的AK信息
                access_key_id=os.getenv("ALIBABA_CLOUD_ACCESS_KEY_ID"),
                access_key_secret=os.getenv("ALIBABA_CLOUD_ACCESS_KEY_SECRET")
            )
        # 杭州与北京上海等地区的endpoint不同，此处进行判断
        if RegionID != 'cn-hangzhou':
            config.endpoint = f'ecs.{RegionID}.aliyuncs.com'
        else:
            config.endpoint = f'ecs-{RegionID}.aliyuncs.com'
        client = Ecs20140526Client(config)
        describe_instances_request = ecs_20140526_models.DescribeInstancesRequest(region_id=RegionID)
        runtime = util_models.RuntimeOptions()
        # 获得ECS实例信息
        response_source = client.describe_instances_with_options(describe_instances_request, runtime).body
        if len(response_source.instances.instance) == 0:
            return "您在当前区域无ecs实例"
        # 初始化要返回的结果
        result = ""
        # 可能有多个实例，因此用for循环遍历所有实例
        for i in range(len(response_source.instances.instance)):
            # 系统盘类型与存储空间，此处默认设为cloud_auto，40GiB
            system_disk = ecs_20140526_models.DescribePriceRequestSystemDisk(
                category='cloud_auto',
                size=40
            )
            describe_price_request = ecs_20140526_models.DescribePriceRequest(
                region_id=RegionID,
                resource_type='instance',
                instance_type=response_source.instances.instance[i].instance_type,
                system_disk=system_disk
            )
            response = client.describe_price_with_options(describe_price_request, runtime).body
            cur_result = f"""实例：{response_source.instances.instance[i].instance_id} 的规格为：{response_source.instances.instance[i].instance_type}，
    每个小时的收费为{response.price_info.price.trade_price}元\n"""
            # 将当前实例的信息添加到返回结果中
            result += cur_result
        return result
    @classmethod
    # RAG应用调用
    def call_agent_app(cls,InstanceType):
        if len(InstanceType) == 0:
            return "您在当前区域无ecs实例"
        result = ""
        for i in range(len(InstanceType)):
            response = Application.call(
                # 此处填写RAG应用的app_id
                app_id='xxx',
                prompt=f'介绍一下{InstanceType[i]}',
                # 从环境变量中获取Dashscope的API Key
                api_key=os.getenv("DASHSCOPE_API_KEY"))
            result += response.output.text
        return result

class Billing:
    # 无需输入，返回为阿里云账户余额信息
    @classmethod
    def get_balance(cls):
        # 创建客户端
        config = open_api_models.Config(
            # 必填，请确保代码运行环境设置了环境变量 ALIBABA_CLOUD_ACCESS_KEY_ID。,
            access_key_id=os.environ['ALIBABA_CLOUD_ACCESS_KEY_ID'],
            # 必填，请确保代码运行环境设置了环境变量 ALIBABA_CLOUD_ACCESS_KEY_SECRET。,
            access_key_secret=os.environ['ALIBABA_CLOUD_ACCESS_KEY_SECRET']
        )
        # Endpoint 请参考 https://api.aliyun.com/product/BssOpenApi
        config.endpoint = f'business.aliyuncs.com'
        runtime = util_models.RuntimeOptions()
        client = BssOpenApi20171214Client(config)
        balance_info = client.query_account_balance_with_options(runtime).body.data
        return f"""币种为：{balance_info.currency}，可用额度为{balance_info.available_amount}，信控余额为{balance_info.credit_amount}，
        网商余额为{balance_info.mybank_credit_amount}，现金余额为{balance_info.available_cash_amount}，生态客户Quota限额为{balance_info.quota_limit}。"""

if __name__ == '__main__':
    print(ECS.query_source('cn-hangzhou'))</code></pre></section><section id="dcdd6d7caaja3" class="section"><h3 id="aeedf988edl8c"><b>main.py（用于创建<span class="help-letter-space"></span>Agent<span class="help-letter-space"></span>并定义交互方式）</b></h3><p id="112c90166cg8n">main.py<span class="help-letter-space"></span>主要作用为：</p><ol id="20c54563d1ing"><li id="3ece864749pz5"><p id="d4785c25926tb"><a href="#500dd9f204hnn" id="9c05d43c9c7ao" title="" class="xref">创建<span class="help-letter-space"></span>Agent</a></p></li><li id="d0eafb6d5dyji"><p id="3f6307aaffffz"><a href="#84ef33296e2m3" id="3bd3df6d37h6i" title="" class="xref">定义消息传递函数</a></p></li><li id="24cf318cd71j2"><p id="4312d4dbfdwfk"><a href="#6baccf59b53dl" id="eed129f48600r" title="" class="xref">定义<span class="help-letter-space"></span>Agent<span class="help-letter-space"></span>之间交互方式并获得回复</a></p></li><li id="448c6b55abbs0"><p id="87a6993d007ak"><a href="#f831f5a09cll1" id="67bb92eb792zu" title="" class="xref">前端展示界面</a></p></li></ol><p id="292cca3507omk">其整体代码可见：<a href="#2e8890d4c02ko" id="f5a0238e5272w" title="" class="xref">main.py<span class="help-letter-space"></span>整体代码</a>。</p><h4 id="5c16f7efabgut"><b>引入依赖</b></h4><pre id="ec581b4610dbb" code-type="xCode" data-tag="codeblock" outputclass="language-python" props="china" data-cond-props="china" class="pre codeblock language-python"><code>from dashscope import Assistants, Messages, Runs, Threads
import json
# 从tools.py导入工具函数
from tools import ECS,Billing
# 引入前端界面展示依赖
import gradio as gr

# 将列表形式的字符串解析为列表形式的数据，例如："['a','b']"--&gt;['a','b']。
# 用于将plannerassistant的输出解析为元素为assistant的列表
import ast</code></pre><h4 id="500dd9f204hnn"><b>创建<span class="help-letter-space"></span>Agent</b></h4><p id="bccb6b787ej2d">本教程共包含五个<span class="help-letter-space"></span>Agent，集成的工具函数与功能请见下表：</p><table id="07637da99blpi" tablewidth="100" tablecolswidth="33.96 25.83 40.21" autofit="true" class="table"><colgroup colwidth="1.03*" style="width:33.96%"></colgroup><colgroup colwidth="0.78*" style="width:25.83%"></colgroup><colgroup colwidth="1.22*" style="width:40.21%"></colgroup><tbody class="tbody"><tr id="d9f2659a7b0v7"><td id="6fe5497fc7puz" rowspan="1" style="background-color:#e5e5e5" colspan="1"><p id="3a38b80620ruc"><b>Agent<span class="help-letter-space"></span>名称</b></p></td><td id="2e892dda7epg7" rowspan="1" style="background-color:#e5e5e5" colspan="1"><p id="95ef93f1c9i8a"><b>集成的工具函数</b></p></td><td id="2481daa7916b2" rowspan="1" style="background-color:#e5e5e5" colspan="1"><p id="b1a97bc3df1gt"><b>功能</b></p></td></tr><tr id="bfd87f261dtyl"><td id="c41f6be6d1ox0" rowspan="1" style="background-color:rgba(0, 0, 0, 0)" colspan="1"><p id="9a0d3130e90b4"><a href="#1003688998p0x" id="724dd7a6599ev" title="" class="xref">PlannerAssistant</a></p></td><td id="d6721d851c924" rowspan="1" style="background-color:rgba(0, 0, 0, 0)" colspan="1"><p id="9e09c52fd6yj0">无</p></td><td id="96496a982dd10" rowspan="1" style="background-color:rgba(0, 0, 0, 0)" colspan="1"><p id="759effea32jv0">对<span class="help-letter-space"></span>Multi Agent<span class="help-letter-space"></span>进行编排。</p></td></tr><tr id="216844f13cal8"><td id="0cf7ec7418z5m" rowspan="1" style="background-color:rgba(0, 0, 0, 0)" colspan="1"><p id="5b70eabfbbb2r"><a href="#f8193817d4mas" id="719cf84e029zd" title="" class="xref">ChatAssistant</a></p></td><td id="9fb27d85c9oo6" rowspan="1" style="background-color:rgba(0, 0, 0, 0)" colspan="1"><p id="67ec5e7b8bna7">无</p></td><td id="cd19de3a28ybl" rowspan="1" style="background-color:rgba(0, 0, 0, 0)" colspan="1"><p id="0b6a1e54de0un">如果无需使用工具，则使用该<span class="help-letter-space"></span>Agent<span class="help-letter-space"></span>进行回答。</p></td></tr><tr id="656579746cfcz" style="height:68px"><td id="2498209dfclzg" rowspan="1" style="background-color:rgba(0, 0, 0, 0)" colspan="1"><p id="6f1385f0dbnww"><a href="#b15f21daf2xw3" id="13d5146a5chy5" title="" class="xref">AliyunInfoAssistant</a></p></td><td id="9a012422b968x" rowspan="1" style="background-color:rgba(0, 0, 0, 0)" colspan="1"><p id="907c93ac12c18"><code data-tag="code" code-type="xCode" id="0fdae076f8xex" class="code">query_source</code>与<code data-tag="code" code-type="xCode" id="4cd5b73294r6o" class="code">get_balance</code></p></td><td id="657b945583qng" rowspan="1" style="background-color:rgba(0, 0, 0, 0)" colspan="1"><p id="d8dddad820okn">查询阿里云的资源信息，包括<span class="help-letter-space"></span>ECS<span class="help-letter-space"></span>实例与阿里云余额。</p></td></tr><tr id="129082c2a38gi" style="height:42px"><td id="1faa7875bblus" rowspan="1" style="background-color:rgba(0, 0, 0, 0)" colspan="1"><p id="8828e02a08nrj"><a href="#8908de55dd7kx" id="5ae67ff70asru" title="" class="xref">InstanceTypeDetailAssistant</a></p></td><td id="b2b7b91637l54" rowspan="1" style="background-color:rgba(0, 0, 0, 0)" colspan="1"><p id="0b1f28111e1jf"><code data-tag="code" code-type="xCode" id="0d65c1f2c9nlg" class="code">call_agent_app</code></p></td><td id="b6f27e32c49a9" rowspan="1" style="background-color:rgba(0, 0, 0, 0)" colspan="1"><p id="2bf33ea1ca81n">查询指定实例规格的指标数据。</p></td></tr><tr id="bb203d27d1wuw"><td id="f8065cefd4dq1" rowspan="1" style="background-color:rgba(0, 0, 0, 0)" colspan="1"><p id="e58048bddd72x"><a href="#1d19a35d6233s" id="dd9db0ead39dk" title="" class="xref">SummaryAssistant</a></p></td><td id="5b818d8de0hv6" rowspan="1" style="background-color:rgba(0, 0, 0, 0)" colspan="1"><p id="412698dec0tk9">无</p></td><td id="d842c346edlb0" rowspan="1" style="background-color:rgba(0, 0, 0, 0)" colspan="1"><p id="fd39af99bfr8d">结合前序<span class="help-letter-space"></span>Agent<span class="help-letter-space"></span>的输出，对用户问题进行全面、完整的回复。</p></td></tr></tbody></table><p id="76336e060dnj4">五个<span class="help-letter-space"></span>Agent<span class="help-letter-space"></span>的详情如下：</p><div id="21585aceadt9a" type="note" class="note note-note"><div class="note-icon-wrapper"><i class="icon-note note note"></i></div><div class="noteContentSpan"><strong>说明 </strong><p id="223ae8b75b0i8">Agent<span class="help-letter-space"></span>中的大模型通过<span class="help-letter-space"></span>Assistants.create<span class="help-letter-space"></span>方法的<code data-tag="code" code-type="xCode" id="5c9bf04ddd0gx" class="code">model</code>参数定义；Agent<span class="help-letter-space"></span>的功能由<span class="help-letter-space"></span>Assistants.create<span class="help-letter-space"></span>方法中的<code data-tag="code" code-type="xCode" id="31f3cb704ezev" class="code">tools</code>参数定义；您可以通过<span class="help-letter-space"></span>Assistants.create<span class="help-letter-space"></span>中的<code data-tag="code" code-type="xCode" id="e7fb422fe1s53" class="code">instructions</code>指引<span class="help-letter-space"></span>Agent<span class="help-letter-space"></span>使用工具的方式，以及<span class="help-letter-space"></span>Agent<span class="help-letter-space"></span>的输出格式等，例如让<span class="help-letter-space"></span>Agent<span class="help-letter-space"></span>以<span class="help-letter-space"></span>JSON<span class="help-letter-space"></span>格式输出字符串。具体实现代码请参考以下五个<span class="help-letter-space"></span>Agent<span class="help-letter-space"></span>的代码实现。</p></div></div><section id="b9e2c075e8qeh" outputclass="tabbed-content-box" data-tag="tabbed-content-box" class="tabbed-content-box section"><section id="d57b80abdc2ny" class="section"><h2 id="1003688998p0x">PlannerAssistant</h2><p id="cb7d160953zq2">PlannerAssistant<span class="help-letter-space"></span>负责根据用户的输入与其它<span class="help-letter-space"></span>agent<span class="help-letter-space"></span>的功能，编排<span class="help-letter-space"></span>Multi Agent<span class="help-letter-space"></span>的工作方式，是<span class="help-letter-space"></span>Multi Agent<span class="help-letter-space"></span>的核心。在得到<span class="help-letter-space"></span>PlannerAssistant<span class="help-letter-space"></span>输出后，需要在后续程序中进行字符串解析，将其解析成列表形式的数据。代码如下：</p><pre code-type="xCode" id="26cadf005dwqe" data-tag="codeblock" outputclass="language-python" props="china" data-cond-props="china" class="pre codeblock language-python"><code># 决策级别的agent，决定使用哪些agent，以及它们的运行顺序
PlannerAssistant = Assistants.create(
    # 因为该Agent作用比较重要，因此建议选择性能较强的大模型：qwen-plus。模型列表：https://help.aliyun.com/zh/model-studio/getting-started/models
    model="qwen-plus",
    # 定义Agent的名称
    name='流程编排机器人',
    # 定义Agent的功能描述
    description='你是团队的leader，你的手下有很多assistant，你需要根据用户的输入，决定要以怎样的顺序去使用这些assistant',
    # 定义对Agent的指示语句，Agent会按照指示语句进行工具的调用并返回结果。
    instructions="""你的团队中有以下assistant。AliyunInfoAssistant：可以查询用户指定区域的阿里云ecs实例信息，或者查询用户的阿里云余额；InstanceTypeDetailAssistant：可以查询指定阿里云ecs实例规格的详细信息，比如cpu核数、内存大小等，可以一次查询多个实例规格信息，因此无需多次调用；
    ChatAssistant：如果用户的问题无需以上两个assistant，则调用该assistant。你需要根据用户的问题，判断要以什么顺序使用这些assistant，你的返回形式是一个列表，不能返回其它信息。比如：["AliyunInfoAssistant", "AliyunInfoAssistant","InstanceTypeDetailAssistant"]或者["ChatAssistant"]，列表中的元素只能为上述的assistant"""
)</code></pre></section><section id="ce62b7688cbp1" class="section"><h2 id="f8193817d4mas"><b>ChatAssistant</b></h2><p id="fa3d2eb879wcx">ChatAssistant<span class="help-letter-space"></span>的功能是回复日常问题，可以使用成本较低的模型（如<span class="help-letter-space"></span>qwen-flash）作为<span class="help-letter-space"></span>agent<span class="help-letter-space"></span>的底座模型。</p><pre code-type="xCode" id="e1600f79ebknd" data-tag="codeblock" outputclass="language-python" class="pre codeblock language-python"><code># 功能是回复日常问题。对于日常问题来说，可以使用价格较为低廉的模型作为agent的基座
ChatAssistant = Assistants.create(
    # 因为该Agent对大模型性能要求不高，因此使用成本较低的qwen-flash模型
    model="qwen-flash",
    name='回答日常问题的机器人',
    description='一个智能助手，解答用户的问题',
    instructions='请礼貌地回答用户的问题'
)</code></pre></section><section id="27c17f24bfmz7" class="section"><h2 id="b15f21daf2xw3"><b>AliyunInfoAssistant</b></h2><p id="f8bdd9704fmzf">AliyunInfoAssistant<span class="help-letter-space"></span>的功能是查询阿里云的资源信息。目前有<span class="help-letter-space"></span>ecs<span class="help-letter-space"></span>实例查询与阿里云余额查询两个功能。代码详情为：</p><pre code-type="xCode" id="f31dd13356d46" data-tag="codeblock" outputclass="language-python" props="china" data-cond-props="china" class="pre codeblock language-python"><code># 功能是查询阿里云的资源信息。目前有ecs实例查询与阿里云余额查询两个功能
AliyunInfoAssistant = Assistants.create(
    model="qwen-plus", # 模型列表：https://help.aliyun.com/zh/model-studio/getting-started/models
    name='阿里云资源信息查询机器人',
    description='一个智能助手，根据用户的查询去调用工具并返回查询到的阿里云资源结果',
    instructions='你是一个智能助手，你有两个功能，分别是阿里云ecs实例信息查询和阿里云余额查询。请准确判断调用哪个工具，并礼貌地回答用户的问题。',
    # 定义Agent使用的工具，您可以根据您的业务场景在tools列表中定义一个或多个Agent可能会使用的工具。
    tools=[
        {
            'type': 'function',
            'function': {
                # 工具函数的名称，可通过下文代码中的function_mapper将name映射到函数本体
                'name': 'ecs实例信息查询',
                # 工具函数的描述
                'description': '当需要查询阿里云ecs实例信息时非常有用，比如实例id，实例规格，收费信息等',
                # 工具函数的入参
                'parameters': {
                    'type': 'object',
                    'properties': {
                        # 该工具需要用户输入地域信息
                        'RegionID': {
                            'type': 'str',
                            # 参数的描述信息
                            'description': '用户想要查询实例所属的地域id，如果是杭州，则为cn-hangzhou，如果是上海，则为cn-shanghai，如果是北京，则为cn-beijing'
                        },
                    },
                    'required': ['RegionID']},
            }
        },
        {
            'type': 'function',
            'function': {
                'name': '阿里云余额查询',
                # 工具函数的描述
                'description': '当需要查询阿里云账户信息时非常有用',
                # 工具函数的入参，余额查询无需入参，因此为空
                'parameters': {}
            }
        }
    ]
)</code></pre></section><section id="dfb880c1552lo" class="section"><h2 id="8908de55dd7kx"><b>InstanceTypeDetailAssistant</b></h2><p id="fb986d7c47nrb">InstanceTypeDetailAssistant<span class="help-letter-space"></span>接收<b>实例规格列表</b>信息，并通过<code data-tag="code" code-type="xCode" id="688216a158nzo" class="code">call_agent_app</code>函数将每一种实例规格对<span class="help-letter-space"></span>RAG<span class="help-letter-space"></span>应用进行查询，将每种实例规格返回的<span class="help-letter-space"></span>vCPU<span class="help-letter-space"></span>个数、内存大小等指标数据汇总作为输出。</p><pre code-type="xCode" id="856420f500zod" data-tag="codeblock" outputclass="language-python" props="china" data-cond-props="china" class="pre codeblock language-python"><code># 功能是通过在阿里云百炼平台创建的RAG应用查询实例规格的详细信息
InstanceTypeDetailAssistant = Assistants.create(
    model="qwen-plus", # 模型列表：https://help.aliyun.com/zh/model-studio/getting-started/models
    name='ecs实例规格介绍机器人',
    description='一个智能助手，可以通过用户提供的实例规格，调用已有的插件能力给用户介绍实例规格信息。',
    instructions='你是一个智能助手，你需要从输入中精确提取出实例规格信息，如[ecs.e-c1m1.large]，或[ecs.u1-c1m4.xlarge,ecs.e-c1m1.large]。将实例规格列表输入工具中，获得它们的详细信息',
    tools=[
        {
            'type': 'function',
            'function': {
                'name': 'ecs实例规格介绍',
                'description': '返回客户查询指定ecs实例规格的信息',
                'parameters': {
                    'type': 'object',
                    'properties': {
                        'InstanceType': {
                            'type': 'list',
                            'InstanceType': '用户想要查询的实例规格，有可能是一个，有可能是多个，如：[ecs.e-c1m1.large]，或[ecs.u1-c1m4.xlarge,ecs.e-c1m1.large]'
                        },
                    },
                    'required': ['InstanceType']},
            }
        }
    ]
)</code></pre></section><section id="d27381a4d9o8e" class="section"><h2 id="1d19a35d6233s">SummaryAssistant</h2><p id="659e7c24611ae">每一个<span class="help-letter-space"></span>Agent<span class="help-letter-space"></span>都会有输出信息，因此需要一个用于总结的<span class="help-letter-space"></span>Agent<span class="help-letter-space"></span>将前序的<span class="help-letter-space"></span>Agent<span class="help-letter-space"></span>输出信息进行总结，从而对用户的问题进行全面、完整的回答。代码详情如下：</p><pre code-type="xCode" id="e397eb7b95p3a" data-tag="codeblock" outputclass="language-python" props="china" data-cond-props="china" class="pre codeblock language-python"><code># 在Multi Agent场景下，定义一个用于总结的Agent，该Agent会根据用户的问题与之前Agent输出的参考信息，全面、完整地回答用户问题
SummaryAssistant = Assistants.create(
    model="qwen-plus", # 模型列表：https://help.aliyun.com/zh/model-studio/getting-started/models
    name='总结机器人',
    description='一个智能助手，根据用户的问题与参考信息，全面、完整地回答用户问题',
    instructions='你是一个智能助手，根据用户的问题与参考信息，全面、完整地回答用户问题'
)
</code></pre></section></section><h4 id="02e5c730a46hq">定义字符串与函数、字符串与<span class="help-letter-space"></span>Agent<span class="help-letter-space"></span>本体的映射</h4><p id="b6c60c4a14xsh">由于大模型生成的是字符串形式的结果，因此我们在程序中需要对大模型生成的字符串进行解析、映射等操作，以达到和外界交互的功能。</p><pre id="33e353637cat7" code-type="xCode" data-tag="codeblock" outputclass="language-python" class="pre codeblock language-python"><code># 将工具函数的name映射到函数本体
function_mapper = {
    "ecs实例信息查询": ECS.query_source,
    "ecs实例规格介绍":ECS.call_agent_app,
    "阿里云余额查询":Billing.get_balance
}
# 将Agent的name映射到Agent本体
assistant_mapper = {
    "ChatAssistant": ChatAssistant,
    "AliyunInfoAssistant":AliyunInfoAssistant,
    "InstanceTypeDetailAssistant":InstanceTypeDetailAssistant
}</code></pre><h4 id="84ef33296e2m3"><b>定义消息传递函数</b></h4><p id="655193c758ysz">消息传递函数<code data-tag="code" code-type="xCode" id="7be08fac5c87t" class="code">get_agent_response</code>接收<span class="help-letter-space"></span>assistant<span class="help-letter-space"></span>与<span class="help-letter-space"></span>message<span class="help-letter-space"></span>两个参数，用于获得指定<span class="help-letter-space"></span>Agent<span class="help-letter-space"></span>在接收到输入<span class="help-letter-space"></span>message<span class="help-letter-space"></span>时的输出信息。</p><pre code-type="xCode" id="3b2d291b5ew7q" data-tag="codeblock" outputclass="language-python" class="pre codeblock language-python"><code># 输入message信息，输出为指定Agent的回复
def get_agent_response(assistant, message=''):
    # 打印出输入Agent的信息
    print(f"Query: {message}")
    thread = Threads.create()
    message = Messages.create(thread.id, content=message)
    run = Runs.create(thread.id, assistant_id=assistant.id)
    run_status = Runs.wait(run.id, thread_id=thread.id)
    # 如果响应失败，会打印出run failed
    if run_status.status == 'failed':
        print('run failed:')
    # 如果需要工具来辅助大模型输出，则进行以下流程
    if run_status.required_action:
        f = run_status.required_action.submit_tool_outputs.tool_calls[0].function
        # 获得function name
        func_name = f['name']
        # 获得function 的入参
        param = json.loads(f['arguments'])
        # 打印出工具信息
        print("function is",f)
        # 根据function name，通过function_mapper映射到函数，并将参数输入工具函数得到output输出
        if func_name in function_mapper:
            output = function_mapper[func_name](**param)
        else:    
            output = ""
        tool_outputs = [{
            'output':
                output
        }]
        run = Runs.submit_tool_outputs(run.id,
                                       thread_id=thread.id,
                                       tool_outputs=tool_outputs)
        run_status = Runs.wait(run.id, thread_id=thread.id)
    run_status = Runs.get(run.id, thread_id=thread.id)
    msgs = Messages.list(thread.id)
    # 将Agent的输出返回
    return msgs['data'][0]['content'][0]['text']['value']</code></pre></section><h4 id="6baccf59b53dl"><b>定义<span class="help-letter-space"></span>Agent<span class="help-letter-space"></span>之间交互方式并获得回复</b></h4><p id="d99f4771f3itn">Agent<span class="help-letter-space"></span>之间的交互步骤根据<span class="help-letter-space"></span><a href="#1003688998p0x" id="843681648bwoo" title="" class="xref">PlannerAssistant</a><span class="help-letter-space"></span>进行编排，为了适配<span class="help-letter-space"></span>Gradio<span class="help-letter-space"></span>的前端界面展示，输入输出的参数需要与<span class="help-letter-space"></span>Gradio<span class="help-letter-space"></span>中的组件进行对齐。代码如下：</p><div id="e0b6208a3frl2" type="note" class="note note-note"><div class="note-icon-wrapper"><i class="icon-note note note"></i></div><div class="noteContentSpan"><strong>说明 </strong><p id="d8a53f222brke">使用<code data-tag="code" class="code blog-code" code-type="xCode" id="1b88abb657db9">yield</code>关键字而不是<code data-tag="code" class="code blog-code" code-type="xCode" id="bb7a086ba44pa">return</code>，可以迭代地生成和返回中间结果。这样，中间结果可以逐步传递给前端界面，实现实时显示，而不必等到所有结果生成后再显示。</p></div></div><pre id="83d0d80fabc11" code-type="xCode" data-tag="codeblock" outputclass="language-python" class="pre codeblock language-python"><code># 获得Multi Agent的回复，输入与输出需要与Gradio前端展示界面中的参数对齐
def get_multi_agent_response(query,history):
    # 处理输入为空的情况
    if len(query) == 0:
        return "",history+[("","")],"",""
    # 获取Agent的运行顺序
    assistant_order = get_agent_response(PlannerAssistant,query)
    try:
        order_stk = ast.literal_eval(assistant_order)
        cur_query = query
        Agent_Message = ""
        # 依次运行Agent
        for i in range(len(order_stk)):
            yield "-----&gt;".join(order_stk),history+[(query,"multi agent正在努力工作中...")],Agent_Message+'\n'+f"*{order_stk[i]}*正在处理中...",""
            cur_assistant = assistant_mapper[order_stk[i]]
            response = get_agent_response(cur_assistant,cur_query)
            Agent_Message += f"*{order_stk[i]}*的回复为：{response}\n\n"
            yield "-----&gt;".join(order_stk),history+[(query,"multi agent正在努力工作中...")],Agent_Message,""
            # 如果当前Agent为最后一个Agent，则将其输出作为Multi Agent的输出
            if i == len(order_stk)-1:
                prompt = f"请参考已知的信息：{Agent_Message}，回答用户的问题：{query}。"
                multi_agent_response = get_agent_response(SummaryAssistant,prompt)
                yield "-----&gt;".join(order_stk),history+[(query,multi_agent_response)],Agent_Message,""
            # 如果当前Agent不是最后一个Agent，则将上一个Agent的输出response添加到下一轮的query中，作为参考信息
            else:
                # 在参考信息前后加上特殊标识符，可以防止大模型混淆参考信息与提问
                cur_query = f"你可以参考已知的信息：{response}你要完整地回答用户的问题。问题是：{query}。"
    # 兜底策略，如果上述程序运行失败，则直接调用ChatAssistant
    except Exception as e:
        yield "ChatAssistant",[(query,get_agent_response(ChatAssistant,query))],"",""
</code></pre><p id="a61f0bd98aynb">输入参数为<span class="help-letter-space"></span>query<span class="help-letter-space"></span>与<span class="help-letter-space"></span>history。其中<span class="help-letter-space"></span>query<span class="help-letter-space"></span>为用户的提问（字符串形式），history<span class="help-letter-space"></span>为用户与<span class="help-letter-space"></span>Multi Agent<span class="help-letter-space"></span>的对话记录（列表形式）。</p><p id="11edf67a0elut">第一个输出参数为<span class="help-letter-space"></span>Agent<span class="help-letter-space"></span>的编排信息（字符串形式），第二个输出参数为用户与<span class="help-letter-space"></span>Multi Agent<span class="help-letter-space"></span>的对话历史（列表形式），第三个输出参数为当前运行<span class="help-letter-space"></span>Agent<span class="help-letter-space"></span>的状态（字符串形式），为了适配<span class="help-letter-space"></span>Gradio<span class="help-letter-space"></span>组件，第四个输出参数为用户的输入框（字符串形式，设为<code data-tag="code" code-type="xCode" id="455c00d08cyo8" class="code">""</code>以达到用户发起提问后将输入框清空的效果）。</p><h4 id="f831f5a09cll1">前端展示界面</h4><p id="18a4f1b009tyu">本教程使用<span class="help-letter-space"></span>gradio<span class="help-letter-space"></span>作为前端展示工具。gradio<span class="help-letter-space"></span>可以快速帮助机器学习工作者创建模型效果展示界面，代码详情如下：</p><pre id="3808fbe68f4yn" code-type="xCode" data-tag="codeblock" outputclass="language-python" class="pre codeblock language-python"><code># 前端界面展示
with gr.Blocks() as demo:
    # 在界面中央展示标题
    gr.HTML('&lt;center&gt;&lt;h1&gt;欢迎使用阿里云资源查询bot&lt;/h1&gt;&lt;/center&gt;')
    gr.HTML('&lt;center&gt;&lt;h3&gt;支持的功能有指定区域的ecs实例查询、余额查询、实例规格详情查询。您可以在tools.py中添加您需要的工具，并在main.py中配置相关的agent&lt;/h3&gt;&lt;/center&gt;')
    with gr.Row():
        with gr.Column(scale=10):
            chatbot = gr.Chatbot(value=[["hello","很高兴见到您！您想问关于阿里云资源的哪些问题呢？"]],height=600)
        with gr.Column(scale=4):
            text1 = gr.Textbox(label="assistant选择")
            text2 = gr.Textbox(label="当前assistant状态",lines=22)
    with gr.Row():
        msg = gr.Textbox(label="输入",placeholder="您想了解什么呢？")
    # 一些示例问题
    with gr.Row():
        examples = gr.Examples(examples=[
            '我的阿里云余额还有多少钱啊',
            '我在杭州有哪些ecs实例，把它的实例id，价钱以及实例规格详情告诉我',
            '我想了解ecs.u1-c1m4.xlarge和ecs.gn6i-c4g1.xlarge的指标'],inputs=[msg])
    clear = gr.ClearButton([text1,chatbot,text2,msg])
    msg.submit(get_multi_agent_response, [msg,chatbot], [text1,chatbot,text2,msg])</code></pre><h4 id="2e8890d4c02ko"><code data-tag="code" code-type="xCode" id="113507760eg6v" class="code"><b>main.py</b></code><b>整体代码</b></h4><pre id="b1110b118ajx1" code-type="xCode" data-tag="codeblock" outputclass="language-python" props="china" data-cond-props="china" class="pre codeblock language-python"><code>from dashscope import Assistants, Messages, Runs, Threads
import json
# 从tools.py导入工具函数
from tools import ECS,Billing
# 引入前端界面展示依赖
import gradio as gr
import ast

# 决策级别的agent，决定使用哪些agent，以及它们的运行顺序
PlannerAssistant = Assistants.create(
    # 因为该Agent作用比较重要，因此建议选择性能较强的大模型：qwen-plus。模型列表：https://help.aliyun.com/zh/model-studio/getting-started/models
    model="qwen-plus",
    # 定义Agent的名称
    name='流程编排机器人',
    # 定义Agent的功能描述
    description='你是团队的leader，你的手下有很多assistant，你需要根据用户的输入，决定要以怎样的顺序去使用这些assistant',
    # 定义对Agent的指示语句，Agent会按照指示语句进行工具的调用并返回结果。
    instructions="""你的团队中有以下assistant。AliyunInfoAssistant：可以查询用户指定区域的阿里云ecs实例信息，或者查询用户的阿里云余额；InstanceTypeDetailAssistant：可以查询指定阿里云ecs实例规格的详细信息，比如cpu核数、内存大小等，可以一次查询多个实例规格信息，因此无需多次调用；
    ChatAssistant：如果用户的问题无需以上两个assistant，则调用该assistant。你需要根据用户的问题，判断要以什么顺序使用这些assistant，你的返回形式是一个列表，不能返回其它信息。比如：["AliyunInfoAssistant", "AliyunInfoAssistant","InstanceTypeDetailAssistant"]或者["ChatAssistant"]，列表中的元素只能为上述的assistant"""
)

# 功能是回复日常问题。对于日常问题来说，可以使用价格较为低廉的模型作为agent的基座
ChatAssistant = Assistants.create(
    # 因为该Agent对大模型性能要求不高，因此使用成本较低的qwen-flash模型。模型列表：https://help.aliyun.com/zh/model-studio/getting-started/models
    model="qwen-flash",
    name='回答日常问题的机器人',
    description='一个智能助手，解答用户的问题',
    instructions='请礼貌地回答用户的问题'
)

# 功能是查询阿里云的资源信息。目前有ECS实例查询与阿里云余额查询两个功能
AliyunInfoAssistant = Assistants.create(
    model="qwen-plus",  # 模型列表：https://help.aliyun.com/zh/model-studio/getting-started/models
    name='阿里云资源信息查询机器人',
    description='一个智能助手，根据用户的查询去调用工具并返回查询到的阿里云资源结果',
    instructions='你是一个智能助手，你有两个功能，分别是阿里云ecs实例信息查询和阿里云余额查询。请准确判断调用哪个工具，并礼貌地回答用户的问题。',
    # 定义Agent使用的工具，您可以根据您的业务场景在tools列表中定义一个或多个Agent可能会使用的工具。
    tools=[
        {
            'type': 'function',
            'function': {
                # 工具函数的名称，可通过下文代码中的function_mapper将name映射到函数本体
                'name': 'ecs实例信息查询',
                # 工具函数的描述
                'description': '当需要查询阿里云ecs实例信息时非常有用，比如实例id，实例规格，收费信息等',
                # 工具函数的入参
                'parameters': {
                    'type': 'object',
                    'properties': {
                        # 该工具需要用户输入地域信息
                        'RegionID': {
                            'type': 'str',
                            # 参数的描述信息
                            'description': '用户想要查询实例所属的地域id，如果是杭州，则为cn-hangzhou，如果是上海，则为cn-shanghai，如果是北京，则为cn-beijing'
                        },
                    },
                    'required': ['RegionID']},
            }
        },
        {
            'type': 'function',
            'function': {
                'name': '阿里云余额查询',
                # 工具函数的描述
                'description': '当需要查询阿里云账户信息时非常有用',
                # 工具函数的入参，余额查询无需入参，因此为空
                'parameters': {}
            }
        }
    ]
)

# 功能是通过在阿里云百炼平台创建的RAG应用查询实例规格的详细信息
InstanceTypeDetailAssistant = Assistants.create(
    model="qwen-plus",  # 模型列表：https://help.aliyun.com/zh/model-studio/getting-started/models
    name='ecs实例规格介绍机器人',
    description='一个智能助手，可以通过用户提供的输入，精确识别提到的实例规格。调用已有的插件能力给用户介绍实例规格信息。',
    instructions='你是一个智能助手，你需要从用户的输入中精确识别提取出阿里云的实例规格信息，如[ecs.e-c1m1.large]，或[ecs.u1-c1m4.xlarge,ecs.e-c1m1.large]。将实例规格列表输入工具中，获得它们的详细信息',
    tools=[
        {
            'type': 'function',
            'function': {
                'name': 'ecs实例规格介绍',
                'description': '返回客户查询指定ecs实例规格的信息',
                'parameters': {
                    'type': 'object',
                    'properties': {
                        'InstanceType': {
                            'type': 'list',
                            'InstanceType': '用户想要查询的实例规格，有可能是一个，有可能是多个，如：[ecs.e-c1m1.large]，或[ecs.u1-c1m4.xlarge,ecs.e-c1m1.large]'
                        },
                    },
                    'required': ['InstanceType']},
            }
        }
    ]
)

# 在Multi Agent场景下，定义一个用于总结的Agent，该Agent会根据用户的问题与之前Agent输出的参考信息，全面、完整地回答用户问题
SummaryAssistant = Assistants.create(
    model="qwen-plus",  # 模型列表：https://help.aliyun.com/zh/model-studio/getting-started/models
    name='总结机器人',
    description='一个智能助手，根据用户的问题与参考信息，全面、完整地回答用户问题',
    instructions='你是一个智能助手，根据用户的问题与参考信息，全面、完整地回答用户问题'
)

# 将工具函数的name映射到函数本体
function_mapper = {
    "ecs实例信息查询": ECS.query_source,
    "ecs实例规格介绍":ECS.call_agent_app,
    "阿里云余额查询":Billing.get_balance
}
# 将Agent的name映射到Agent本体
assistant_mapper = {
    "ChatAssistant": ChatAssistant,
    "AliyunInfoAssistant":AliyunInfoAssistant,
    "InstanceTypeDetailAssistant":InstanceTypeDetailAssistant
}

# 输入message信息，输出为指定Agent的回复
def get_agent_response(assistant, message=''):
    # 打印出输入Agent的信息
    print(f"Query: {message}")
    thread = Threads.create()
    message = Messages.create(thread.id, content=message)
    run = Runs.create(thread.id, assistant_id=assistant.id)
    run_status = Runs.wait(run.id, thread_id=thread.id)
    # 如果响应失败，会打印出run failed
    if run_status.status == 'failed':
        print('run failed:')
    # 如果需要工具来辅助大模型输出，则进行以下流程
    if run_status.required_action:
        f = run_status.required_action.submit_tool_outputs.tool_calls[0].function
        # 获得function name
        func_name = f['name']
        # 获得function 的入参
        param = json.loads(f['arguments'])
        # 打印出工具信息
        print("function is",f)
        # 根据function name，通过function_mapper映射到函数，并将参数输入工具函数得到output输出
        if func_name in function_mapper:
            output = function_mapper[func_name](**param)
        else:    
            output = ""
        tool_outputs = [{
            'output':
                output
        }]
        run = Runs.submit_tool_outputs(run.id,
                                       thread_id=thread.id,
                                       tool_outputs=tool_outputs)
        run_status = Runs.wait(run.id, thread_id=thread.id)
    run_status = Runs.get(run.id, thread_id=thread.id)
    msgs = Messages.list(thread.id)
    # 将Agent的输出返回
    return msgs['data'][0]['content'][0]['text']['value']

# 获得Multi Agent的回复，输入与输出需要与Gradio前端展示界面中的参数对齐
def get_multi_agent_response(query,history):
    # 处理输入为空的情况
    if len(query) == 0:
        return "",history+[("","")],"",""
    # 获取Agent的运行顺序
    assistant_order = get_agent_response(PlannerAssistant,query)
    try:
        order_stk = ast.literal_eval(assistant_order)
        cur_query = query
        Agent_Message = ""
        # 依次运行Agent
        for i in range(len(order_stk)):
            yield "-----&gt;".join(order_stk),history+[(query,"multi agent正在努力工作中...")],Agent_Message+'\n'+f"*{order_stk[i]}*正在处理中...",""
            cur_assistant = assistant_mapper[order_stk[i]]
            response = get_agent_response(cur_assistant,cur_query)
            Agent_Message += f"*{order_stk[i]}*的回复为：{response}\n\n"
            yield "-----&gt;".join(order_stk),history+[(query,"multi agent正在努力工作中...")],Agent_Message,""
            # 如果当前Agent为最后一个Agent，则将其输出作为Multi Agent的输出
            if i == len(order_stk)-1:
                prompt = f"请参考已知的信息：{Agent_Message}，回答用户的问题：{query}。"
                multi_agent_response = get_agent_response(SummaryAssistant,prompt)
                yield "-----&gt;".join(order_stk),history+[(query,multi_agent_response)],Agent_Message,""
            # 如果当前Agent不是最后一个Agent，则将上一个Agent的输出response添加到下一轮的query中，作为参考信息
            else:
                # 在参考信息前后加上特殊标识符，可以防止大模型混淆参考信息与提问
                cur_query = f"你可以参考已知的信息：{response}你要完整地回答用户的问题。问题是：{query}。"
    # 兜底策略，如果上述程序运行失败，则直接调用ChatAssistant
    except Exception as e:
        yield "ChatAssistant",[(query,get_agent_response(ChatAssistant,query))],"",""


# 前端界面展示
with gr.Blocks() as demo:
    # 在界面中央展示标题
    gr.HTML('&lt;center&gt;&lt;h1&gt;欢迎使用阿里云资源查询bot&lt;/h1&gt;&lt;/center&gt;')
    gr.HTML('&lt;center&gt;&lt;h3&gt;支持的功能有指定区域的ecs实例查询、余额查询、实例规格详情查询。您可以在tools.py中添加您需要的工具，并在main.py中配置相关的agent&lt;/h3&gt;&lt;/center&gt;')
    with gr.Row():
        with gr.Column(scale=10):
            chatbot = gr.Chatbot(value=[["hello","很高兴见到您！您想问关于阿里云资源的哪些问题呢？"]],height=600)
        with gr.Column(scale=4):
            text1 = gr.Textbox(label="assistant选择")
            text2 = gr.Textbox(label="当前assistant状态",lines=22)
    with gr.Row():
        msg = gr.Textbox(label="输入",placeholder="您想了解什么呢？")
    # 一些示例问题
    with gr.Row():
        examples = gr.Examples(examples=[
            '我的阿里云余额还有多少钱啊',
            '我在杭州有哪些ecs实例，把它的实例id，价钱以及实例规格详情告诉我',
            '我想了解ecs.u1-c1m4.xlarge和ecs.gn6i-c4g1.xlarge的指标'],inputs=[msg])
    clear = gr.ClearButton([text1,chatbot,text2,msg])
    msg.submit(get_multi_agent_response, [msg,chatbot], [text1,chatbot,text2,msg])

if __name__ == '__main__':
    demo.launch()
</code></pre><h3 id="00685b35celja">运行效果</h3><p id="31f7d6b5a07zf">请您在配置<code data-tag="code" code-type="xCode" id="6a89c067e1sn7" class="code">ALIBABA_CLOUD_ACCESS_KEY_ID</code>、<code data-tag="code" code-type="xCode" id="04e72f5e2c177" class="code">ALIBABA_CLOUD_ACCESS_KEY_SECRET</code>和<code data-tag="code" code-type="xCode" id="3bb20e7cf1mvn" class="code">DASHSCOPE_API_KEY</code>到环境变量后，运行<code data-tag="code" code-type="xCode" id="2319ec9de2wvz" class="code">main.py</code>文件。终端页面会有<code data-tag="code" code-type="xCode" id="2984cc9b5eqne" class="code">Running on local URL:</code> 的输出，访问对应<span class="help-letter-space"></span>URL，进入交互界面。输入：<span data-tag="code" code-type="xCode" props="china" id="ea1da606aaj0t" data-cond-props="china" class="code">我想知道我在杭州的<span class="help-letter-space"></span>ecs<span class="help-letter-space"></span>实例，还有我的阿里云余额</span>，或者单击<span class="help-letter-space"></span><b data-tag="uicontrol" id="25e17c64454z0" class="uicontrol">Examples</b><span class="help-letter-space"></span>中的示例问题，将其添加到输入框中，并单击<span class="help-letter-space"></span>Enter，等待结果的生成。您可以观察<b data-tag="uicontrol" id="d0885ecd65joz" class="uicontrol">当前<span class="help-letter-space"></span>assistant<span class="help-letter-space"></span>状态</b>框来查看<span class="help-letter-space"></span>Agent<span class="help-letter-space"></span>的实时状态。<img id="f1670254832uw" src="https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/9873322271/p824552.png" alt="image" placement="break" width="800" props="china" data-cond-props="china" class="image break"></p><p id="fed40344bfkrr"></p></section><section id="ffcbcc6d18htl" class="section"><h2 id="5ae32ee9catxg"><b>总结</b></h2><p id="61b67dd834y7w">通过本教程，您可以了解到将阿里云百炼<span class="help-letter-space"></span>RAG<span class="help-letter-space"></span>应用与阿里云的<span class="help-letter-space"></span>OpenAPI<span class="help-letter-space"></span>能力集成到<span class="help-letter-space"></span>Agent<span class="help-letter-space"></span>中的方式，以及使用阿里云百炼平台的<span class="help-letter-space"></span>Assistants API<span class="help-letter-space"></span>进行<span class="help-letter-space"></span>Multi Agent<span class="help-letter-space"></span>开发的步骤，并最终通过基于<span class="help-letter-space"></span>Gradio<span class="help-letter-space"></span>的前端界面展示出来。</p><p id="a3d93d32a3b1m">您可以通过修改<span class="help-letter-space"></span>Agent<span class="help-letter-space"></span>中的提示词、细化<span class="help-letter-space"></span>Agent<span class="help-letter-space"></span>之间的交互方式、修改工具函数等方法，将<span class="help-letter-space"></span>Multi Agent<span class="help-letter-space"></span>应用到您的业务中。</p></section></div></main>

</div></div><div class="aliyun-docs-pagination"><div class="NextPage--container--cfVcdEE"><span class="NextPage--paginationLeft--WTOmehr"><a href="/zh/model-studio/create-an-ai-shopping-assistant" data-spm-click="gostr=/aliyun;locaid=preDoc"><i class="iconfont icon-prev-arrow"></i>上一篇：10分钟构建主动提问的智能导购</a></span><span class="NextPage--paginationRight--TgS6P1r"><a href="/zh/model-studio/model-training-best-practices" data-spm-click="gostr=/aliyun;locaid=nextDoc">下一篇：自定义模型最佳实践<i class="iconfont icon-next-arrow"></i></a></span></div></div></div><div class="RecommendDoc--container--M1qVQax"></div><div class="FeedbackButton--feedbackContainer--njtB22l aliyun-docs-feedback" id="help-doc-feedback"><div class="FeedbackButton--feedbackHelpTip--JxaBwdy">该文章对您有帮助吗？</div><div class="FeedbackButton--feedbackButtonContainer--ujiXFNJ"><div class="FeedbackButton--feedbackButtonBox--GmY1Nor"><button class="FeedbackButton--iconButton--fx4Xcop"><i class="help-iconfont help-icon-tag-empty"></i></button><button class="FeedbackButton--iconButton--fx4Xcop"><i class="help-iconfont help-icon-tag-empty" style="display:inline-block;transform:rotateX(-180deg)"></i></button><button class="FeedbackButton--clickButton--YxH6n96"><i class="help-iconfont help-icon-bianji"></i>反馈</button></div></div></div></section><div class="aliyun-docs-side" id="aliyun-docs-side"><div id="aliyun-docs-side-content" class="aliyun-docs-side-content ProductDetail--rightBox--GGLE5sH"><ul class="Outline--synopsisBox--zm_HamD"></ul></div><div id="aliyun-docs-side-blank" class="aliyun-docs-side-blank"></div></div></div></main></div></div><div id="aliyun-docs-selection-div"></div></div></div>
  <footer><div id="6badab605baf8b24001e9d83177599a4"><div class="_18a32969382a277c44015217fbc5cb5a_box"><footer class="_49ada0cd752f65901c49f2eed0d6c3d5_container" aria-label="PC 端页尾"><div class="_49ada0cd752f65901c49f2eed0d6c3d5_inner"><div class="b34f022d45e42bd104ce1362bc0808b1_services"><nav class="b34f022d45e42bd104ce1362bc0808b1_homepage-footer-main-services" aria-label="页脚导航"><section class="a52e48969cced2d562e47543eeb73ebb_ali-main-services"><h3 class="a52e48969cced2d562e47543eeb73ebb_ali-main-services-title">为什么选择阿里云</h3><a class="a52e48969cced2d562e47543eeb73ebb_ali-main-services-link" href="https://www.aliyun.com/about/what-is-cloud-computing" target="_blank">什么是云计算</a><a class="a52e48969cced2d562e47543eeb73ebb_ali-main-services-link" href="https://infrastructure.aliyun.com/" target="_blank">全球基础设施</a><a class="a52e48969cced2d562e47543eeb73ebb_ali-main-services-link" href="https://www.aliyun.com/why-us/leading-technology" target="_blank">技术领先</a><a class="a52e48969cced2d562e47543eeb73ebb_ali-main-services-link" href="https://www.aliyun.com/why-us/reliability" target="_blank">稳定可靠</a><a class="a52e48969cced2d562e47543eeb73ebb_ali-main-services-link" href="https://www.aliyun.com/why-us/security-compliance" target="_blank">安全合规</a><a class="a52e48969cced2d562e47543eeb73ebb_ali-main-services-link" href="https://www.aliyun.com/analyst-reports" target="_blank">分析师报告</a></section><section class="a52e48969cced2d562e47543eeb73ebb_ali-main-services"><h3 class="a52e48969cced2d562e47543eeb73ebb_ali-main-services-title">大模型</h3><a class="a52e48969cced2d562e47543eeb73ebb_ali-main-services-link" href="https://www.aliyun.com/product/tongyi" target="_blank">通义大模型</a><a class="a52e48969cced2d562e47543eeb73ebb_ali-main-services-link" href="https://bailian.console.aliyun.com/?tab=model#/model-market" target="_blank" rel="nofollow">大模型服务</a><a class="a52e48969cced2d562e47543eeb73ebb_ali-main-services-link" href="https://bailian.console.aliyun.com/app-center?tab=app#/app-center" target="_blank" rel="nofollow">AI应用构建</a></section><section class="a52e48969cced2d562e47543eeb73ebb_ali-main-services"><h3 class="a52e48969cced2d562e47543eeb73ebb_ali-main-services-title">产品和定价</h3><a class="a52e48969cced2d562e47543eeb73ebb_ali-main-services-link" href="https://www.aliyun.com/product/list" target="_blank">全部产品</a><a class="a52e48969cced2d562e47543eeb73ebb_ali-main-services-link" href="https://free.aliyun.com/" target="_blank">免费试用</a><a class="a52e48969cced2d562e47543eeb73ebb_ali-main-services-link" href="https://www.aliyun.com/product/news/" target="_blank">产品动态</a><a class="a52e48969cced2d562e47543eeb73ebb_ali-main-services-link" href="https://www.aliyun.com/price/detail" target="_blank">产品定价</a><a class="a52e48969cced2d562e47543eeb73ebb_ali-main-services-link" href="https://www.aliyun.com/price/cpq/list" target="_blank">配置报价器</a><a class="a52e48969cced2d562e47543eeb73ebb_ali-main-services-link" href="https://www.aliyun.com/price/cost-management" target="_blank">云上成本管理</a></section><section class="a52e48969cced2d562e47543eeb73ebb_ali-main-services"><h3 class="a52e48969cced2d562e47543eeb73ebb_ali-main-services-title">技术内容</h3><a class="a52e48969cced2d562e47543eeb73ebb_ali-main-services-link" href="https://www.aliyun.com/solution/tech-solution" target="_blank">技术解决方案</a><a class="a52e48969cced2d562e47543eeb73ebb_ali-main-services-link" href="https://help.aliyun.com/" target="_blank">帮助文档</a><a class="a52e48969cced2d562e47543eeb73ebb_ali-main-services-link" href="https://developer.aliyun.com/" target="_blank">开发者社区</a><a class="a52e48969cced2d562e47543eeb73ebb_ali-main-services-link" href="https://tianchi.aliyun.com/" target="_blank">天池大赛</a><a class="a52e48969cced2d562e47543eeb73ebb_ali-main-services-link" href="https://edu.aliyun.com/" target="_blank">阿里云认证</a></section><section class="a52e48969cced2d562e47543eeb73ebb_ali-main-services"><h3 class="a52e48969cced2d562e47543eeb73ebb_ali-main-services-title">权益</h3><a class="a52e48969cced2d562e47543eeb73ebb_ali-main-services-link" href="https://free.aliyun.com/" target="_blank">免费试用</a><a class="a52e48969cced2d562e47543eeb73ebb_ali-main-services-link" href="https://www.aliyun.com/solution/free" target="_blank">解决方案免费试用</a><a class="a52e48969cced2d562e47543eeb73ebb_ali-main-services-link" href="https://university.aliyun.com/" target="_blank">高校计划</a><a class="a52e48969cced2d562e47543eeb73ebb_ali-main-services-link" href="https://www.aliyun.com/benefit/form/index" target="_blank">5亿算力补贴</a><a class="a52e48969cced2d562e47543eeb73ebb_ali-main-services-link" href="https://dashi.aliyun.com/?ambRef=shouYeDaoHang2&amp;pageCode=yunparterIndex" target="_blank">推荐返现计划</a></section><section class="a52e48969cced2d562e47543eeb73ebb_ali-main-services"><h3 class="a52e48969cced2d562e47543eeb73ebb_ali-main-services-title">服务</h3><a class="a52e48969cced2d562e47543eeb73ebb_ali-main-services-link" href="https://www.aliyun.com/service" target="_blank">基础服务</a><a class="a52e48969cced2d562e47543eeb73ebb_ali-main-services-link" href="https://www.aliyun.com/service/supportplans" target="_blank">企业增值服务</a><a class="a52e48969cced2d562e47543eeb73ebb_ali-main-services-link" href="https://www.aliyun.com/service/devopsimpl/devopsimpl_cloudmigration_public_cn" target="_blank">迁云服务</a><a class="a52e48969cced2d562e47543eeb73ebb_ali-main-services-link" href="https://www.aliyun.com/notice/" target="_blank">官网公告</a><a class="a52e48969cced2d562e47543eeb73ebb_ali-main-services-link" href="https://status.aliyun.com/" target="_blank">健康看板</a><a class="a52e48969cced2d562e47543eeb73ebb_ali-main-services-link" href="https://security.aliyun.com/trust-center" target="_blank">信任中心</a></section></nav><article class="_7b44142961778903dda8af3f769cd06c_focus"><h3 class="_7b44142961778903dda8af3f769cd06c_ali-main-services-title">关注阿里云</h3><p class="_7b44142961778903dda8af3f769cd06c_ali-main-services-desc">关注阿里云公众号或下载阿里云APP，关注云资讯，随时随地运维管控云服务</p><img alt="阿里云APP" src="https://img.alicdn.com/imgextra/i4/O1CN01XLesV31fkf7pYNATb_!!6000000004045-2-tps-400-400.png" class="_7b44142961778903dda8af3f769cd06c_ali-official-code" loading="lazy"/><img alt="阿里云微信" src="https://img.alicdn.com/tfs/TB1AOdINW6qK1RjSZFmXXX0PFXa-258-258.jpg" class="_7b44142961778903dda8af3f769cd06c_ali-official-code" loading="lazy"/><p class="_7b44142961778903dda8af3f769cd06c_consult-text">联系我们：4008013260</p></article></div><div class="_4598709a854bea355ceb6ef9f23f10d4_about-link-wrap"><a href="https://help.aliyun.com/product/67275.html" class="_4598709a854bea355ceb6ef9f23f10d4_ali-about-link" target="_blank">法律声明</a><a href="https://terms.alicdn.com/legal-agreement/terms/platform_service/20220906101446934/20220906101446934.html" class="_4598709a854bea355ceb6ef9f23f10d4_ali-about-link" target="_blank">Cookies政策</a><a href="https://aliyun.jubao.alibaba.com/" class="_4598709a854bea355ceb6ef9f23f10d4_ali-about-link" target="_blank">廉正举报</a><a href="https://report.aliyun.com/" class="_4598709a854bea355ceb6ef9f23f10d4_ali-about-link" target="_blank">安全举报</a><a href="https://www.aliyun.com/contact" class="_4598709a854bea355ceb6ef9f23f10d4_ali-about-link" target="_blank">联系我们</a><a href="https://careers.aliyun.com/" class="_4598709a854bea355ceb6ef9f23f10d4_ali-about-link" target="_blank">加入我们</a></div><section class="_4598709a854bea355ceb6ef9f23f10d4_friend-link-wrap"><h3 hidden="">友情链接</h3><a href="https://www.alibabagroup.com/cn/global/home" class="_4598709a854bea355ceb6ef9f23f10d4_ali-friend-link" target="_blank">阿里巴巴集团</a><a href="https://www.taobao.com/" class="_4598709a854bea355ceb6ef9f23f10d4_ali-friend-link" target="_blank">淘宝网</a><a href="https://www.tmall.com/" class="_4598709a854bea355ceb6ef9f23f10d4_ali-friend-link" target="_blank">天猫</a><a href="https://www.aliexpress.com/" class="_4598709a854bea355ceb6ef9f23f10d4_ali-friend-link" target="_blank">全球速卖通</a><a href="https://www.alibaba.com/" class="_4598709a854bea355ceb6ef9f23f10d4_ali-friend-link" target="_blank">阿里巴巴国际交易市场</a><a href="https://www.1688.com/" class="_4598709a854bea355ceb6ef9f23f10d4_ali-friend-link" target="_blank">1688</a><a href="https://www.alimama.com/index.htm" class="_4598709a854bea355ceb6ef9f23f10d4_ali-friend-link" target="_blank">阿里妈妈</a><a href="https://www.fliggy.com/" class="_4598709a854bea355ceb6ef9f23f10d4_ali-friend-link" target="_blank">飞猪</a><a href="https://www.aliyun.com/" class="_4598709a854bea355ceb6ef9f23f10d4_ali-friend-link" target="_blank">阿里云计算</a><a href="https://www.alios.cn/" class="_4598709a854bea355ceb6ef9f23f10d4_ali-friend-link" target="_blank">AliOS</a><a href="https://wanwang.aliyun.com/" class="_4598709a854bea355ceb6ef9f23f10d4_ali-friend-link" target="_blank">万网</a><a href="https://mobile.amap.com/" class="_4598709a854bea355ceb6ef9f23f10d4_ali-friend-link" target="_blank">高德</a><a href="https://www.uc.cn/" class="_4598709a854bea355ceb6ef9f23f10d4_ali-friend-link" target="_blank">UC</a><a href="https://www.umeng.com/" class="_4598709a854bea355ceb6ef9f23f10d4_ali-friend-link" target="_blank">友盟</a><a href="https://www.youku.com/" class="_4598709a854bea355ceb6ef9f23f10d4_ali-friend-link" target="_blank">优酷</a><a href="https://www.dingtalk.com/" class="_4598709a854bea355ceb6ef9f23f10d4_ali-friend-link" target="_blank">钉钉</a><a href="https://www.alipay.com/" class="_4598709a854bea355ceb6ef9f23f10d4_ali-friend-link" target="_blank">支付宝</a><a href="https://damo.alibaba.com/" class="_4598709a854bea355ceb6ef9f23f10d4_ali-friend-link" target="_blank">达摩院</a><a href="https://world.taobao.com/" class="_4598709a854bea355ceb6ef9f23f10d4_ali-friend-link" target="_blank">淘宝海外</a><a href="https://www.aliyundrive.com/" class="_4598709a854bea355ceb6ef9f23f10d4_ali-friend-link" target="_blank">阿里云盘</a><a href="https://www.ele.me/" class="_4598709a854bea355ceb6ef9f23f10d4_ali-friend-link" target="_blank">饿了么</a></section><p class="_4598709a854bea355ceb6ef9f23f10d4_ali-copyright-text">© 2009-现在 Aliyun.com 版权所有 增值电信业务经营许可证： <a href="http://beian.miit.gov.cn/" target="_blank">浙B2-20080101</a> 域名注册服务机构许可： <a href="https://domain.miit.gov.cn/域名注册服务机构/互联网域名/阿里云计算有限公司 " target="_blank">浙D3-20210002</a></p><p class="_4598709a854bea355ceb6ef9f23f10d4_ali-report-wrap"><a href="https://zzlz.gsxt.gov.cn/businessCheck/verifKey.do?showType=p&amp;serial=91330106673959654P-SAIC_SHOW_10000091330106673959654P1710919400712&amp;signData=MEUCIQDEkCd8cK7%2Fyqe6BNMWvoMPtAnsgKa7FZetfPkjZMsvhAIgOX1G9YC6FKyndE7o7hL0KaBVn4f%20V%2Fiof3iAgpsV09o%3D" target="_blank" class="_4598709a854bea355ceb6ef9f23f10d4_ali-report-link"><img src="//gw.alicdn.com/tfs/TB1GxwdSXXXXXa.aXXXXXXXXXXX-65-70.gif" class="_4598709a854bea355ceb6ef9f23f10d4_ali-report-img" alt="" loading="lazy"/></a><a href="http://www.beian.gov.cn/portal/registerSystemInfo" target="_blank" class="_4598709a854bea355ceb6ef9f23f10d4_ali-report-link"><img src="//img.alicdn.com/tfs/TB1..50QpXXXXX7XpXXXXXXXXXX-40-40.png" class="_4598709a854bea355ceb6ef9f23f10d4_ali-report-img" alt="浙公网安备 33010602009975号" loading="lazy"/><span class="_4598709a854bea355ceb6ef9f23f10d4_ali-report-link-text">浙公网安备 33010602009975号</span></a><a href="https://beian.miit.gov.cn/" target="_blank" class="_4598709a854bea355ceb6ef9f23f10d4_ali-report-link"><span class="_4598709a854bea355ceb6ef9f23f10d4_ali-report-link-text _4598709a854bea355ceb6ef9f23f10d4_ali-report-link-text-unique">浙B2-20080101-4</span></a></p></div></footer><footer class="_4b41e3343c851a7a8833c9165b249eb2_container" aria-label="移动端页尾"></footer></div></div></footer>



<script>

  // 白屏时间埋点
  window.firstPaint = Date.now();
  const ssrFistPaintTime = firstPaint-performance.timing.navigationStart;
  var ssrTime = {
  product: 'help.aliyun.com', // 站点
  ua: navigator.userAgent, // ua
  device: 'pc', // 设备
  page: 'documentDetail', // 页面
  lang: 'zh', //站点语言
  cna: '', // 用户标识
  url: window.location.href,
  action: 'ssrFirstPaint',
  userParams1: ssrFistPaintTime,
  userParams2: window.firstPaint,
  userParams3: performance.timing.navigationStart
  };
  let queryStr = Object.keys(ssrTime).map(key => ssrTime[key] &&
    `${encodeURIComponent(key)}=${encodeURIComponent(ssrTime[key])}`).join('&');
  fetch('https://help-new.cn-wulanchabu.log.aliyuncs.com/logstores/web-tracking/track?APIVersion=0.6.0&' +
  queryStr);

  document.addEventListener("DOMContentLoaded", function(event) {
    // pcp上报
    window.ALIYUN_PERF && window.ALIYUN_PERF.report();
  window.ALIYUN_PERF && window.ALIYUN_PERF.getPCP().then(rst => {
    // pcp埋点
    var data = {
      product: 'help.aliyun.com', // 站点
      ua: navigator.userAgent, // ua
      device: 'pc', // 设备
      page: 'index', // 页面
      lang: 'zh', //站点语言
      cna: '', // 用户标识
      url: window.location.href,
      action: 'pcp',
      userParams1: rst || 0,
    };
    let queryStr = Object.keys(data).map(key => data[key] &&
      `${encodeURIComponent(key)}=${encodeURIComponent(data[key])}`).join('&');
    fetch('https://help-new.cn-wulanchabu.log.aliyuncs.com/logstores/web-tracking/track?APIVersion=0.6.0&' +
      queryStr);
    });
  });
</script>

<script crossorigin="" src="https://g.alicdn.com/code/lib/??react/16.8.6/umd/react.production.min.js,react-dom/16.8.6/umd/react-dom.production.min.js"></script>
<script src="https://g.alicdn.com/code/lib/lodash.js/4.17.21/lodash.min.js" crossorigin="anonymous"></script>

<script>
  window.resourceBaseUrl="https://g.alicdn.com/aliyun-help/help-portal-fe/0.12.24/"
</script>
<script defer="" src="https://g.alicdn.com/aliyun-help/help-portal-fe/0.12.24/js/index.js"></script>
<script defer src="https://g.alicdn.com/aliyun-help/help-portal-fe/0.12.24/js/vendor.js"></script>
<script async="" src="https://g.alicdn.com/dawn/assets-loader/scripts/fast-login.js?tenantName=help-new-aliyun-com"></script>
<script defer="" src="https://cloud-assets.alicdn.com/website.js"></script>
<script async="" src="https://g.alicdn.com/aliyun/perf/js/index.js"></script>
<script src="https://g.alicdn.com/code/npm/@ali/??biu-loader/0.1.2/index.js,hmod-preact/0.0.1/index.js,hmod-preact-hooks/0.0.1/index.js,hmod-preact-compat/0.0.1/index.js,hmod-preact-bridge/0.1.4/index.js,hmod-ace-service-loader/0.1.1/index.js"></script>
<script src="https://g.alicdn.com/aliyun-com/lowcode-engine/0.1.73/renderer/build/js/index.js"></script>
<script src="https://g.alicdn.com/code/npm/@ali??hmod-ace-2023-box/0.1.0/index.js,hmod-aliyun-com-floating-toolbar/0.2.4/index.js,hmod-aliyun-com-global-nav-search/0.7.13/index.js,hmod-aliyun-com-global-nav/0.2.50/index.js"></script>
<script src="https://cloud-assets.alicdn.com/lowcode/entry/prod/ccd960598cacfbfb0b6848d42529a646.js"></script>
<script src="https://g.alicdn.com/code/npm/@ali??hmod-ace-2023-box/0.1.0/index.js,hmod-ace-2024-global-footer/0.1.2/index.js,hmod-lowcode-normal-page/0.1.0/index.js"></script>
<script src="https://cloud-assets.alicdn.com/lowcode/entry/prod/6badab605baf8b24001e9d83177599a4.js"></script>
<script src="https://cloud-assets.alicdn.com/website.js"></script>
</body></html>
